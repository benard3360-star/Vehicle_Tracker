{% extends 'base.html' %}

{% block page_title_text %}Dashboard{% endblock %}
{% block page_subtitle %}Vehicle Movement Intelligence & AI Analytics System{% endblock %}

{% block content %}
<style>
    /* Modern Dashboard Styles */
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Welcome Section - Clean & Minimal */
    .welcome-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px 32px;
        margin-bottom: 32px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .welcome-content h2 {
        font-size: 24px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
    }

    .welcome-content p {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
    }

    .welcome-meta {
        text-align: right;
    }

    .welcome-date {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }

    .role-badge {
        display: inline-block;
        padding: 4px 12px;
        background: #f3f4f6;
        color: #374151;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 4px;
        border: 1px solid #e5e7eb;
    }

    /* KPI Cards - Clean & Professional */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 20px;
        margin-bottom: 32px;
    }

    .kpi-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .kpi-card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .kpi-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 16px;
    }

    .kpi-icon {
        width: 48px;
        height: 48px;
        background: #f9fafb;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #6b7280;
    }

    .kpi-card.primary .kpi-icon {
        background: #f0fdf4;
        color: #16a34a;
    }

    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 4px;
        line-height: 1;
    }

    .kpi-label {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }

    .kpi-trend {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: 12px;
        font-weight: 600;
        margin-top: 8px;
        padding: 4px 8px;
        border-radius: 6px;
        background: #f9fafb;
    }

    .kpi-trend.up {
        color: #16a34a;
        background: #f0fdf4;
    }

    .kpi-trend.down {
        color: #dc2626;
        background: #fef2f2;
    }

    /* Module Grid - Simplified */
    .modules-section {
        margin-bottom: 32px;
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
    }

    .module-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 16px;
    }

    .module-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .module-card:hover {
        border-color: #16a34a;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transform: translateY(-2px);
    }

    .module-card.module-restricted {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .module-card.module-restricted:hover {
        border-color: #e5e7eb;
        transform: none;
    }

    .module-icon {
        font-size: 32px;
        margin-bottom: 12px;
    }

    .module-card h3 {
        font-size: 15px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 4px;
    }

    .module-card p {
        font-size: 13px;
        color: #6b7280;
        margin: 0;
    }

    .restricted-badge {
        display: inline-block;
        margin-top: 8px;
        padding: 4px 10px;
        background: #fef2f2;
        color: #dc2626;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 600;
    }

    /* Activity Feed - Clean Design */
    .activity-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .activity-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .activity-header h3 {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .activity-badge {
        padding: 4px 10px;
        background: #f3f4f6;
        color: #6b7280;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 600;
    }

    .activity-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        padding: 16px 24px;
        border-bottom: 1px solid #f3f4f6;
        display: flex;
        align-items: flex-start;
        gap: 16px;
        transition: background 0.15s ease;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-item:hover {
        background: #f9fafb;
    }

    .activity-icon {
        width: 40px;
        height: 40px;
        background: #f9fafb;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 16px;
    }

    .activity-details {
        flex: 1;
        min-width: 0;
    }

    .activity-description {
        font-size: 14px;
        font-weight: 500;
        color: #111827;
        margin-bottom: 4px;
    }

    .activity-meta {
        display: flex;
        gap: 12px;
        font-size: 12px;
        color: #9ca3af;
    }

    .activity-empty {
        padding: 48px 24px;
        text-align: center;
        color: #9ca3af;
    }

    .activity-empty-icon {
        font-size: 48px;
        margin-bottom: 12px;
        opacity: 0.3;
    }

    /* Two Column Layout */
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
        margin-bottom: 32px;
    }

    .dashboard-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .dashboard-card h3 {
        font-size: 16px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 20px;
    }

    /* Quick Actions */
    .quick-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .action-btn {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        text-decoration: none;
        color: #374151;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.15s ease;
    }

    .action-btn:hover {
        background: white;
        border-color: #16a34a;
        color: #16a34a;
    }

    .action-btn i {
        width: 20px;
        text-align: center;
        color: #16a34a;
    }

    /* Quick Access Cards */
    .quick-access-section {
        margin-bottom: 32px;
    }

    .quick-access-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 24px;
        margin-bottom: 32px;
    }

    .quick-access-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 28px 24px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        position: relative;
        overflow: hidden;
    }

    .quick-access-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #16a34a, #15803d);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .quick-access-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        border-color: #16a34a;
    }

    .quick-access-card:hover::before {
        transform: scaleX(1);
    }

    .quick-access-icon {
        font-size: 40px;
        margin-bottom: 16px;
        display: block;
        transition: transform 0.3s ease;
    }

    .quick-access-card:hover .quick-access-icon {
        transform: scale(1.1);
    }

    .quick-access-card h3 {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin-bottom: 8px;
        transition: color 0.3s ease;
    }

    .quick-access-card:hover h3 {
        color: #16a34a;
    }

    .quick-access-card p {
        font-size: 14px;
        color: #6b7280;
        margin: 0;
        font-weight: 500;
    }

    /* Vehicle Analytics Section */
    .vehicle-analytics {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 32px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .analytics-title {
        font-size: 20px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .plate-search {
        display: flex;
        gap: 12px;
        align-items: center;
        margin-bottom: 24px;
    }

    .plate-input {
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        text-transform: uppercase;
        min-width: 200px;
    }

    .plate-input:focus {
        outline: none;
        border-color: #16a34a;
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }

    .search-btn {
        padding: 12px 20px;
        background: #16a34a;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .search-btn:hover {
        background: #15803d;
    }

    .analytics-content {
        display: none;
    }

    .analytics-content.show {
        display: block;
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .analytics-card {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 20px;
        text-align: center;
    }

    .analytics-value {
        font-size: 28px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 4px;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    .analytics-label {
        font-size: 12px;
        color: #374151;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .destinations-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        overflow: hidden;
    }

    .destinations-table th {
        background: #374151;
        padding: 16px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        color: #ffffff;
        border-bottom: 1px solid #4b5563;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .destinations-table td {
        padding: 16px 12px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
        color: #111827;
        font-weight: 500;
        background: #ffffff;
    }

    .destinations-table tr:hover td {
        background: #f8fafc;
        color: #111827;
    }

    .destinations-table td:first-child {
        font-weight: 600;
        color: #16a34a;
    }

    .destinations-table td:nth-child(5) {
        font-weight: 600;
        color: #059669;
    }

    .loading {
        text-align: center;
        padding: 40px;
        color: #6b7280;
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #9ca3af;
    }

    /* AI Assistant Floating Button */
    .ai-assistant-float {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #16a34a, #15803d);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(22, 163, 74, 0.3);
        transition: all 0.3s ease;
        z-index: 1000;
        border: 3px solid white;
    }

    .ai-assistant-float:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(22, 163, 74, 0.4);
        background: linear-gradient(135deg, #15803d, #166534);
    }

    .ai-assistant-float i {
        font-size: 28px;
        color: white;
        animation: pulse 2s infinite;
    }

    .ai-tooltip {
        position: absolute;
        right: 80px;
        top: 50%;
        transform: translateY(-50%);
        background: #111827;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .ai-tooltip::after {
        content: '';
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        border: 6px solid transparent;
        border-left-color: #111827;
    }

    .ai-assistant-float:hover .ai-tooltip {
        opacity: 1;
        visibility: visible;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    /* AI Chat Modal Styles */
    .ai-chat-modal {
        position: fixed;
        top: 0;
        right: 0;
        width: 380px;
        height: 100vh;
        background: white;
        border-left: 1px solid #e5e7eb;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        display: none;
        flex-direction: column;
        overflow: hidden;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .ai-chat-modal.show {
        display: flex;
        transform: translateX(0);
    }

    .dashboard-container.chat-open {
        margin-right: 380px;
        transition: margin-right 0.3s ease;
    }

    .ai-chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .ai-chat-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #16a34a, #15803d);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e5e7eb;
    }

    .ai-chat-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 16px;
    }

    .ai-chat-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background 0.2s ease;
    }

    .ai-chat-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .ai-chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: #f9fafb;
    }

    .ai-message, .user-message {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .user-message {
        flex-direction: row-reverse;
    }

    .ai-avatar, .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
    }

    .ai-avatar {
        background: linear-gradient(135deg, #16a34a, #15803d);
        color: white;
    }

    .user-avatar {
        background: #3b82f6;
        color: white;
    }

    .ai-message-content, .user-message-content {
        background: white;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 280px;
        font-size: 14px;
        line-height: 1.5;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        color: #111827;
        font-weight: 500;
    }

    .user-message-content {
        background: #3b82f6;
        color: white;
    }

    .ai-chat-input {
        padding: 16px 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 12px;
        align-items: center;
        background: white;
    }

    .ai-chat-input input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 24px;
        font-size: 14px;
        outline: none;
    }

    .ai-chat-input input:focus {
        border-color: #16a34a;
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }

    .ai-chat-input button {
        width: 40px;
        height: 40px;
        background: #16a34a;
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
    }

    .ai-chat-input button:hover {
        background: #15803d;
    }

    .ai-chat-input button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
    
    /* Typing indicator styles */
    .typing-dots {
        display: flex;
        gap: 4px;
        align-items: center;
    }
    
    .typing-dots span {
        width: 6px;
        height: 6px;
        background: #6b7280;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
        }

        .kpi-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }

        .analytics-grid {
            grid-template-columns: repeat(2, 1fr);
        }

        .plate-search {
            flex-direction: column;
            align-items: stretch;
        }

        .quick-access-grid {
            grid-template-columns: 1fr;
            gap: 16px;
        }

        .ai-assistant-float {
            width: 56px;
            height: 56px;
            bottom: 20px;
            right: 20px;
        }

        .ai-assistant-float i {
            font-size: 24px;
        }
        
        .ai-chat-modal {
            width: calc(100vw - 40px);
            height: 400px;
            right: 20px;
            bottom: 90px;
        }
    }

    @media (max-width: 768px) {
        .welcome-section {
            flex-direction: column;
            align-items: flex-start;
            gap: 16px;
        }

        .welcome-meta {
            text-align: left;
        }

        .module-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }

        .kpi-grid {
            grid-template-columns: 1fr;
        }

        .quick-access-grid {
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .quick-access-card {
            padding: 20px 16px;
        }

        .quick-access-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }

        .ai-assistant-float {
            width: 52px;
            height: 52px;
            bottom: 16px;
            right: 16px;
        }

        .ai-assistant-float i {
            font-size: 22px;
        }

        .ai-tooltip {
            display: none;
        }
    }
</style>

<div class="dashboard-container">
    <!-- Welcome Section -->
    <div class="welcome-section">
        <div class="welcome-content">
            <h2>Welcome back, {{ user.get_full_name|default:user.username }}!</h2>
            <p>Here's what's happening with your vehicle intelligence system today</p>
        </div>
        <div class="welcome-meta">
            <div class="welcome-date">{{ now|date:"F j, Y" }} ‚Ä¢ {{ now|date:"h:i A" }}</div>
            <div class="role-badge">{{ user.get_role_display }}</div>
        </div>
    </div>

    <!-- KPI Cards -->
    {% if user.is_super_admin %}
    <div class="kpi-grid">
        <div class="kpi-card primary">
            <div class="kpi-header">
                <div>
                    <div class="kpi-value">{{ total_organizations }}</div>
                    <div class="kpi-label">Total Organizations</div>
                </div>
                <div class="kpi-icon">üè¢</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-header">
                <div>
                    <div class="kpi-value">{{ active_organizations }}</div>
                    <div class="kpi-label">Active Organizations</div>
                </div>
                <div class="kpi-icon">‚úÖ</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-header">
                <div>
                    <div class="kpi-value">{{ total_system_users }}</div>
                    <div class="kpi-label">System Users</div>
                </div>
                <div class="kpi-icon">üë•</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-header">
                <div>
                    <div class="kpi-value">{{ total_org_admins }}</div>
                    <div class="kpi-label">Organization Admins</div>
                </div>
                <div class="kpi-icon">üë®‚Äçüíº</div>
            </div>
        </div>
    </div>
    {% elif user.is_organization_admin %}
    <div class="kpi-grid">
        <div class="kpi-card primary">
            <div class="kpi-header">
                <div>
                    <div class="kpi-value">{{ user_count }}</div>
                    <div class="kpi-label">Total Users</div>
                </div>
                <div class="kpi-icon">üë•</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-header">
                <div>
                    <div class="kpi-value">{{ active_users }}</div>
                    <div class="kpi-label">Active Users</div>
                </div>
                <div class="kpi-icon">‚úÖ</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-header">
                <div>
                    <div class="kpi-value">{{ organization.name|truncatechars:12 }}</div>
                    <div class="kpi-label">Organization</div>
                </div>
                <div class="kpi-icon">üè¢</div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Quick Access Cards (Only for regular users) -->
    {% if not user.is_super_admin and not user.is_organization_admin %}
    <div class="quick-access-section">
        <div class="quick-access-grid">
            <div class="quick-access-card" onclick="location.href='{% url 'vehicle_tracking' %}'" id="vehicleTrackingCard">
                <div class="quick-access-icon">üöó</div>
                <h3 id="trackingTitle">Vehicle Tracking</h3>
                <p id="trackingDesc">Real-time location</p>
            </div>
            
            <div class="quick-access-card" onclick="location.href='{% url 'movement_history' %}'" id="movementHistoryCard">
                <div class="quick-access-icon">üìç</div>
                <h3 id="historyTitle">Movement History</h3>
                <p id="historyDesc">Track your routes</p>
            </div>
            
            <div class="quick-access-card" onclick="location.href='{% url 'reports' %}'" id="reportsCard">
                <div class="quick-access-icon">üìã</div>
                <h3 id="reportsTitle">Reports</h3>
                <p id="reportsDesc">Generate reports</p>
            </div>
        </div>
    </div>

    <!-- Vehicle Analytics Section -->
    <div class="vehicle-analytics">
        <div class="analytics-header">
            <h3 class="analytics-title">My Vehicle Analytics</h3>
            <div style="font-size: 14px; color: #6b7280;">Enter your license plate to view detailed analytics</div>
        </div>
        
        <div class="plate-search">
            <input type="text" id="plateNumber" class="plate-input" placeholder="Enter License Plate (e.g., KCA 123A)" maxlength="20">
            <button type="button" id="searchBtn" class="search-btn">
                <i class="fas fa-search"></i> Search
            </button>
        </div>
        
        <div id="analyticsContent" class="analytics-content">
            <div id="loadingState" class="loading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading your vehicle analytics...</p>
            </div>
            
            <div id="analyticsData" style="display: none;">
                <!-- Summary Cards -->
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-value" id="totalVisits">0</div>
                        <div class="analytics-label">Total Visits</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="totalAmount">KSh 0</div>
                        <div class="analytics-label">Total Amount Paid</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="totalTime">0h</div>
                        <div class="analytics-label">Total Parking Time</div>
                    </div>
                    <div class="analytics-card">
                        <div class="analytics-value" id="uniqueDestinations">0</div>
                        <div class="analytics-label">Unique Destinations</div>
                    </div>
                </div>
                
                <!-- Destinations Breakdown -->
                <div style="margin-top: 32px;">
                    <h4 style="font-size: 16px; font-weight: 600; color: #111827; margin-bottom: 16px;">Destinations Breakdown</h4>
                    <div style="overflow-x: auto;">
                        <table class="destinations-table">
                            <thead>
                                <tr>
                                    <th>Destination</th>
                                    <th>Visits</th>
                                    <th>Total Time</th>
                                    <th>Avg Time</th>
                                    <th>Total Amount</th>
                                    <th>Last Visit</th>
                                </tr>
                            </thead>
                            <tbody id="destinationsTableBody">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div id="noDataState" class="no-data" style="display: none;">
                <i class="fas fa-car" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                <h4 style="color: #6b7280; margin-bottom: 8px;">No Vehicle Data Found</h4>
                <p id="noDataMessage">We couldn't find any parking records for this license plate number.</p>
                <div id="debugInfo" style="margin-top: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 12px; color: #6b7280; display: none;">
                    <strong>Available plates in your organization:</strong>
                    <div id="samplePlates" style="margin-top: 8px; font-family: monospace;"></div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modules Section -->
    <div class="modules-section">
        <div class="section-header">
            <h2 class="section-title">Vehicle Intelligence</h2>
        </div>
        <div class="module-grid">


            {% if user.role == 'super_admin' %}
            <div class="module-card" onclick="location.href='{% url 'super_admin_dashboard' %}'">
                <div class="module-icon">üëë</div>
                <h3>Super Admin</h3>
                <p>System control</p>
            </div>
            {% endif %}

            {% if user.role == 'organization_admin' %}
            <div class="module-card" onclick="location.href='{% url 'org_admin_dashboard' %}'">
                <div class="module-icon">üè¢</div>
                <h3>Org Admin</h3>
                <p>Manage users</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Quick Actions -->
        <div class="dashboard-card">
            <h3>Quick Actions</h3>
            <div class="quick-actions">
                <a href="{% url 'profile_view' %}" class="action-btn">
                    <i class="fas fa-user"></i>
                    <span>View My Profile</span>
                </a>
                <a href="{% url 'settings' %}" class="action-btn">
                    <i class="fas fa-cog"></i>
                    <span>Account Settings</span>
                </a>
                <a href="{% url 'ai_assistant' %}" class="action-btn">
                    <i class="fas fa-robot"></i>
                    <span>AI Assistant</span>
                </a>
                <a href="{% url 'help_center' %}" class="action-btn">
                    <i class="fas fa-question-circle"></i>
                    <span>Help & Support</span>
                </a>
            </div>
        </div>

        <!-- System Status -->
        <div class="dashboard-card">
            <h3>System Status</h3>
            <div class="quick-actions">
                <div class="action-btn" style="cursor: default;">
                    <i class="fas fa-check-circle" style="color: #16a34a;"></i>
                    <span>All Systems Operational</span>
                </div>
                <div class="action-btn" style="cursor: default;">
                    <i class="fas fa-database" style="color: #16a34a;"></i>
                    <span>Database Connected</span>
                </div>
                <div class="action-btn" style="cursor: default;">
                    <i class="fas fa-shield-alt" style="color: #16a34a;"></i>
                    <span>Security Active</span>
                </div>
            </div>
        </div>
    </div>


</div>

<!-- AI Assistant Floating Button -->
<div class="ai-assistant-float" id="aiAssistantBtn">
    <div class="ai-tooltip">AI Assistant - Get instant help!</div>
    <i class="fas fa-robot"></i>
</div>

<!-- AI Assistant Chat Modal -->
<div id="aiChatModal" class="ai-chat-modal">
    <div class="ai-chat-container">
        <div class="ai-chat-header">
            <div class="ai-chat-title">
                <i class="fas fa-robot"></i>
                <span>AI Assistant</span>
            </div>
            <button class="ai-chat-close" id="aiChatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-message-content">
                    Hello! I'm your AI assistant. I can help you with vehicle analytics, parking insights, and answer questions about your data. How can I assist you today?
                </div>
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="Ask me anything about your vehicle data..." maxlength="500">
            <button id="aiChatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle restricted module clicks
        const restrictedCards = document.querySelectorAll('.module-card.module-restricted');
        
        restrictedCards.forEach(card => {
            card.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                
                // Show toast notification
                showToast('You don\'t have permission to access this module', 'warning');
            });
        });

        // Toast notification function
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'warning' ? '#f59e0b' : '#16a34a'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 9999;
                font-size: 14px;
                font-weight: 500;
                animation: slideIn 0.3s ease;
            `;
            toast.textContent = message;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Add animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // Vehicle Analytics functionality
        const plateInput = document.getElementById('plateNumber');
        const searchBtn = document.getElementById('searchBtn');
        const analyticsContent = document.getElementById('analyticsContent');
        const loadingState = document.getElementById('loadingState');
        const analyticsData = document.getElementById('analyticsData');
        const noDataState = document.getElementById('noDataState');
        const aiAssistantBtn = document.getElementById('aiAssistantBtn');
        
        // AI Assistant button click handler
        if (aiAssistantBtn) {
            aiAssistantBtn.addEventListener('click', function(e) {
                e.preventDefault();
                toggleAIChat();
            });
        }
        
        // AI Chat functionality
        const aiChatModal = document.getElementById('aiChatModal');
        const aiChatClose = document.getElementById('aiChatClose');
        const aiChatInput = document.getElementById('aiChatInput');
        const aiChatSend = document.getElementById('aiChatSend');
        const aiChatMessages = document.getElementById('aiChatMessages');
        
        function toggleAIChat() {
            aiChatModal.classList.toggle('show');
            document.querySelector('.dashboard-container').classList.toggle('chat-open');
            if (aiChatModal.classList.contains('show')) {
                aiChatInput.focus();
            }
        }
        
        function closeAIChat() {
            aiChatModal.classList.remove('show');
            document.querySelector('.dashboard-container').classList.remove('chat-open');
        }
        
        function sendAIMessage() {
            const message = aiChatInput.value.trim();
            if (!message) return;
            
            addMessage(message, 'user');
            aiChatInput.value = '';
            aiChatSend.disabled = true;
            
            // Show typing indicator
            addTypingIndicator();
            
            // Send to AI API
            fetch('/api/ai-chat/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    message: message,
                    page_type: 'dashboard',
                    filters: {}
                })
            })
            .then(response => response.json())
            .then(data => {
                removeTypingIndicator();
                if (data.success) {
                    addMessage(data.response, 'ai');
                    if (data.source === 'openai') {
                        addMessage('üí° Powered by OpenAI GPT', 'ai', true);
                    }
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'ai');
                }
            })
            .catch(error => {
                removeTypingIndicator();
                console.error('AI Chat Error:', error);
                // Fallback to local response
                const response = getAIResponse(message);
                addMessage(response, 'ai');
            })
            .finally(() => {
                aiChatSend.disabled = false;
            });
        }
        
        function addTypingIndicator() {
            const typingDiv = document.createElement('div');
            typingDiv.className = 'ai-message typing-indicator';
            typingDiv.innerHTML = `
                <div class="ai-avatar"><i class="fas fa-robot"></i></div>
                <div class="ai-message-content">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                </div>
            `;
            aiChatMessages.appendChild(typingDiv);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const typing = document.querySelector('.typing-indicator');
            if (typing) typing.remove();
        }
        
        function getCsrfToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                   document.querySelector('meta[name="csrf-token"]')?.content || '';
        }
        
        function addMessage(content, type, isSmall = false) {
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'user' ? 'user-message' : 'ai-message';
            
            const avatar = document.createElement('div');
            avatar.className = type === 'user' ? 'user-avatar' : 'ai-avatar';
            avatar.innerHTML = type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            
            const messageContent = document.createElement('div');
            messageContent.className = type === 'user' ? 'user-message-content' : 'ai-message-content';
            if (isSmall) messageContent.style.fontSize = '12px';
            messageContent.textContent = content;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(messageContent);
            
            aiChatMessages.appendChild(messageDiv);
            aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
        }
        
        function getAIResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi')) {
                return 'Hello! How can I help you with your vehicle data today?';
            }
            if (lowerMessage.includes('help')) {
                return 'I can help you with vehicle analytics, parking insights, movement history, and generating reports. What would you like to know?';
            }
            if (lowerMessage.includes('analytics') || lowerMessage.includes('data')) {
                return 'You can search for vehicle analytics by entering a license plate number in the search box above. This will show you detailed parking history and statistics.';
            }
            if (lowerMessage.includes('parking')) {
                return 'I can provide insights about parking patterns, duration, costs, and frequently visited locations. Do you have a specific vehicle in mind?';
            }
            if (lowerMessage.includes('report')) {
                return 'You can generate various reports including movement summaries, parking analysis, and cost breakdowns. Would you like me to guide you through the process?';
            }
            
            return 'I understand you are asking about vehicle data. You can search for specific vehicles using license plates, view analytics, or generate reports. Is there something specific you would like to know?';
        }
        
        // AI Chat event listeners
        if (aiChatClose) {
            aiChatClose.addEventListener('click', closeAIChat);
        }
        
        if (aiChatSend) {
            aiChatSend.addEventListener('click', sendAIMessage);
        }
        
        if (aiChatInput) {
            aiChatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });
        }
        
        // Close AI chat when clicking outside
        document.addEventListener('click', function(e) {
            if (aiChatModal.classList.contains('show') && 
                !aiChatModal.contains(e.target) && 
                !aiAssistantBtn.contains(e.target)) {
                closeAIChat();
            }
        });
        
        // Close chat on escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && aiChatModal.classList.contains('show')) {
                closeAIChat();
            }
        });
        
        if (plateInput && searchBtn) {
            // Search on button click
            searchBtn.addEventListener('click', searchVehicleAnalytics);
            
            // Search on Enter key
            plateInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchVehicleAnalytics();
                }
            });
            
            function searchVehicleAnalytics() {
                const plateNumber = plateInput.value.trim().toUpperCase();
                
                if (!plateNumber) {
                    showToast('Please enter a license plate number', 'warning');
                    return;
                }
                
                console.log('Searching for plate:', plateNumber);
                
                // Show loading state
                analyticsContent.classList.add('show');
                loadingState.style.display = 'block';
                analyticsData.style.display = 'none';
                noDataState.style.display = 'none';
                
                // Fetch analytics data
                fetch(`/api/vehicle-analytics/?plate=${encodeURIComponent(plateNumber)}`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                    }
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);
                    loadingState.style.display = 'none';
                    
                    if (data.success && data.analytics) {
                        displayAnalytics(data.analytics);
                        analyticsData.style.display = 'block';
                    } else {
                        console.log('No data or error:', data.error);
                        document.getElementById('noDataMessage').textContent = data.error || 'No vehicle data found';
                        
                        // Show debug info if available
                        if (data.debug_info) {
                            const debugDiv = document.getElementById('debugInfo');
                            const samplePlatesDiv = document.getElementById('samplePlates');
                            
                            let debugText = '';
                            if (data.debug_info.sample_plates_in_org && data.debug_info.sample_plates_in_org.length > 0) {
                                debugText += 'Sample plates: ' + data.debug_info.sample_plates_in_org.join(', ') + '\n\n';
                            }
                            if (data.debug_info.real_analytics_columns) {
                                debugText += 'Real analytics columns: ' + data.debug_info.real_analytics_columns.join(', ') + '\n\n';
                            }
                            if (data.debug_info.combined_dataset_columns) {
                                debugText += 'Combined dataset columns: ' + data.debug_info.combined_dataset_columns.join(', ') + '\n\n';
                            }
                            if (data.debug_info.real_analytics_orgs) {
                                debugText += 'Real analytics orgs: ' + data.debug_info.real_analytics_orgs.join(', ') + '\n';
                            }
                            if (data.debug_info.combined_dataset_orgs) {
                                debugText += 'Combined dataset orgs: ' + data.debug_info.combined_dataset_orgs.join(', ');
                            }
                            
                            samplePlatesDiv.innerHTML = debugText || 'No data found in either table';
                            debugDiv.style.display = 'block';
                        }
                        
                        noDataState.style.display = 'block';
                        resetModuleCards();
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    loadingState.style.display = 'none';
                    noDataState.style.display = 'block';
                    resetModuleCards();
                    showToast('Error loading vehicle analytics', 'error');
                });
            }
            
            function displayAnalytics(analytics) {
                const plateNumber = plateInput.value.trim().toUpperCase();
                
                // Update summary cards
                document.getElementById('totalVisits').textContent = analytics.total_visits;
                document.getElementById('totalAmount').textContent = `KSh ${analytics.total_amount.toFixed(2)}`;
                document.getElementById('totalTime').textContent = `${Math.round(analytics.total_time_hours)}h`;
                document.getElementById('uniqueDestinations').textContent = analytics.unique_destinations;
                
                // Update destinations table
                const tableBody = document.getElementById('destinationsTableBody');
                tableBody.innerHTML = '';
                
                analytics.destinations.forEach(dest => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${dest.destination}</strong></td>
                        <td>${dest.visits}</td>
                        <td>${Math.round(dest.total_time_hours)}h ${Math.round(dest.total_time_minutes % 60)}m</td>
                        <td>${Math.round(dest.avg_time_hours)}h ${Math.round(dest.avg_time_minutes % 60)}m</td>
                        <td>KSh ${dest.total_amount.toLocaleString()}</td>
                        <td>${new Date(dest.last_visit).toLocaleDateString()}</td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Update module cards with vehicle-specific information
                updateModuleCards(plateNumber, analytics);
            }
            
            function updateModuleCards(plateNumber, analytics) {
                // Update Vehicle Tracking card
                document.getElementById('trackingTitle').textContent = `${plateNumber} Tracking`;
                document.getElementById('trackingDesc').textContent = `Current status & location`;
                
                // Update Movement History card
                document.getElementById('historyTitle').textContent = `${plateNumber} History`;
                document.getElementById('historyDesc').textContent = `${analytics.total_visits} trips recorded`;
                
                // Update Reports card
                document.getElementById('reportsTitle').textContent = `${plateNumber} Reports`;
                document.getElementById('reportsDesc').textContent = `${analytics.unique_destinations} destinations visited`;
                
                // Add visual indicator that cards are now vehicle-specific
                const cards = ['vehicleTrackingCard', 'movementHistoryCard', 'reportsCard'];
                cards.forEach(cardId => {
                    const card = document.getElementById(cardId);
                    if (card) {
                        card.style.borderColor = '#16a34a';
                        card.style.boxShadow = '0 8px 24px rgba(22, 163, 74, 0.2)';
                        card.style.transform = 'translateY(-2px)';
                    }
                });
            }
            
            function resetModuleCards() {
                // Reset to default state
                document.getElementById('trackingTitle').textContent = 'Vehicle Tracking';
                document.getElementById('trackingDesc').textContent = 'Real-time location';
                document.getElementById('historyTitle').textContent = 'Movement History';
                document.getElementById('historyDesc').textContent = 'Track your routes';
                document.getElementById('reportsTitle').textContent = 'Reports';
                document.getElementById('reportsDesc').textContent = 'Generate reports';
                
                // Remove visual indicators
                const cards = ['vehicleTrackingCard', 'movementHistoryCard', 'reportsCard'];
                cards.forEach(cardId => {
                    const card = document.getElementById(cardId);
                    if (card) {
                        card.style.borderColor = '#e5e7eb';
                        card.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.04)';
                        card.style.transform = 'translateY(0)';
                    }
                });
            }
        }
    });
</script>
{% endblock %}
