{% extends 'base.html' %}

{% block content %}
<style>
    .users-table {
        width: 100%;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: var(--shadow);
    }
    
    .user-row {
        display: grid;
        grid-template-columns: 2fr 2fr 1fr 2fr 1fr;
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
        align-items: center;
    }
    
    .user-row.header {
        background: var(--light-bg);
        font-weight: 600;
    }
    
    .user-role-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .role-super-admin {
        background-color: #e3f2fd;
        color: #1565c0;
    }
    
    .role-org-admin {
        background-color: #e8f5e9;
        color: #2e7d32;
    }
    
    .user-actions {
        display: flex;
        gap: 0.5rem;
    }
</style>

<div class="admin-container">
    <div class="admin-header">
        <h1>System Users Management</h1>
        <p>Manage super admins and organization admins</p>
    </div>
    
    <div class="users-table">
        <div class="user-row header">
            <div>User</div>
            <div>Organization</div>
            <div>Role</div>
            <div>Last Active</div>
            <div>Actions</div>
        </div>
        
        {% for user in system_users %}
        <div class="user-row">
            <div>
                <strong>{{ user.get_full_name|default:user.username }}</strong>
                <div class="text-muted">{{ user.email }}</div>
                {% if user.phone %}<small>{{ user.phone }}</small>{% endif %}
            </div>
            
            <div>
                {% if user.organization %}
                    {{ user.organization.name }}
                {% else %}
                    <span class="text-muted">System</span>
                {% endif %}
            </div>
            
            <div>
                <span class="user-role-badge {% if user.role == 'super_admin' %}role-super-admin{% else %}role-org-admin{% endif %}">
                    {{ user.get_role_display }}
                </span>
            </div>
            
            <div>
                {% if user.last_active %}
                    {{ user.last_active|timesince }} ago
                {% else %}
                    <span class="text-muted">Never</span>
                {% endif %}
            </div>
            
            <div class="user-actions">
                {% if user.role == 'organization_admin' %}
                <button class="btn btn-sm btn-primary" onclick="resetUserPassword('{{ user.id }}', '{{ user.username }}')">
                    Reset Password
                </button>
                {% endif %}
                <button class="btn btn-sm btn-danger" onclick="deleteUser('{{ user.id }}', '{{ user.username }}')">
                    Delete
                </button>
            </div>
        </div>
        {% empty %}
        <div class="user-row">
            <div colspan="5" class="text-center">No system users found</div>
        </div>
        {% endfor %}
    </div>
</div>

<script>
function resetUserPassword(userId, username) {
    if (confirm('Reset password for ' + username + '?')) {
        fetch('{% url "super_admin_reset_user_password" %}', {
            method: 'POST',
            body: JSON.stringify({ user_id: userId }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Password reset successfully!\nNew temporary password: ' + data.temp_password);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}

function deleteUser(userId, username) {
    if (confirm('Are you sure you want to delete ' + username + '?')) {
        fetch('{% url "super_admin_delete_user" %}', {
            method: 'POST',
            body: JSON.stringify({ user_id: userId }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            alert('Error: ' + error);
        });
    }
}
</script>
{% endblock %}