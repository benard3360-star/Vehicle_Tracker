{% extends 'base.html' %}

{% block title %}Organization Admin Dashboard - Vehicle Intelligence System{% endblock %}

{% block page_title_text %}Organization Admin Dashboard{% endblock %}
{% block page_subtitle %}{{ organization.name }} - Complete Management Overview{% endblock %}

{% block extra_css %}
<style>
    /* Modern Organization Admin Dashboard */
    :root {
        --card-bg: #ffffff;
        --card-border: #e5e7eb;
        --text-primary: #111827;
        --text-secondary: #6b7280;
        --text-muted: #9ca3af;
        --green-50: #f0fdf4;
        --green-100: #dcfce7;
        --green-500: #22c55e;
        --green-600: #16a34a;
        --gray-50: #f9fafb;
        --gray-100: #f3f4f6;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }

    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0;
    }

    .dashboard-header {
        margin-bottom: 32px;
    }

    .dashboard-title {
        font-size: 28px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        letter-spacing: -0.025em;
    }

    .dashboard-subtitle {
        font-size: 16px;
        color: var(--text-secondary);
        font-weight: 400;
    }

    /* KPI Cards */
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
    }

    .kpi-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        padding: 24px;
        transition: all 0.2s ease;
        position: relative;
    }

    .kpi-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-2px);
    }

    .kpi-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .kpi-title {
        font-size: 14px;
        font-weight: 500;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .kpi-icon {
        width: 40px;
        height: 40px;
        background: var(--green-50);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: var(--green-600);
        font-size: 18px;
    }

    .kpi-value {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
        line-height: 1;
    }

    .kpi-change {
        display: flex;
        align-items: center;
        gap: 4px;
        font-size: 14px;
        font-weight: 500;
    }

    .kpi-change.positive {
        color: var(--green-600);
    }

    .kpi-change.neutral {
        color: var(--text-muted);
    }

    /* Content Grid */
    .content-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 32px;
        margin-bottom: 40px;
    }

    .main-content-area {
        display: flex;
        flex-direction: column;
        gap: 32px;
    }

    .sidebar-content {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    /* Modern Cards */
    .modern-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.2s ease;
    }

    .modern-card:hover {
        box-shadow: var(--shadow-md);
    }

    .card-header {
        padding: 20px 24px;
        border-bottom: 1px solid var(--card-border);
        background: var(--gray-50);
    }

    .card-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-primary);
        margin: 0;
    }

    .card-body {
        padding: 24px;
    }

    /* Modern Table */
    .modern-table {
        width: 100%;
        border-collapse: collapse;
    }

    .modern-table th {
        background: var(--gray-50);
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        color: var(--text-secondary);
        border-bottom: 1px solid var(--card-border);
    }

    .modern-table td {
        padding: 16px;
        border-bottom: 1px solid var(--card-border);
        font-size: 14px;
        color: var(--text-primary);
    }

    .modern-table tr:hover {
        background: var(--gray-50);
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        background: var(--green-500);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 14px;
        margin-right: 12px;
    }

    .user-info {
        display: flex;
        align-items: center;
    }

    .user-details {
        display: flex;
        flex-direction: column;
    }

    .user-name {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
    }

    .user-meta {
        font-size: 12px;
        color: var(--text-muted);
    }

    .action-buttons {
        display: flex;
        gap: 8px;
    }

    .btn-sm {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-outline {
        background: transparent;
        border: 1px solid var(--card-border);
        color: var(--text-secondary);
    }

    .btn-outline:hover {
        background: var(--gray-50);
        color: var(--text-primary);
    }

    /* Modern Badges */
    .badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        line-height: 1;
    }

    .badge-success {
        background: var(--green-100);
        color: var(--green-600);
    }

    .badge-warning {
        background: #fef3c7;
        color: #d97706;
    }

    .badge-info {
        background: #dbeafe;
        color: #2563eb;
    }

    .badge-secondary {
        background: var(--gray-100);
        color: var(--text-secondary);
    }

    .activity-timeline {
        max-height: 400px;
        overflow-y: auto;
    }

    .activity-item {
        display: flex;
        gap: 15px;
        padding: 15px 0;
        border-bottom: 1px solid var(--border-green);
        position: relative;
    }

    .activity-item:last-child {
        border-bottom: none;
    }

    .activity-icon {
        width: 36px;
        height: 36px;
        background: var(--info-gradient);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 14px;
        flex-shrink: 0;
        position: relative;
        z-index: 1;
    }

    .activity-item:not(:last-child) .activity-icon::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        width: 2px;
        height: 30px;
        background: var(--border-green);
        z-index: -1;
    }

    .activity-content {
        flex: 1;
        min-width: 0;
    }

    .activity-description {
        font-size: 14px;
        color: var(--text-dark);
        font-weight: 500;
        margin-bottom: 4px;
    }

    .activity-meta {
        font-size: 12px;
        color: var(--text-light);
    }

    .progress-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
    }

    .progress-label {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-dark);
    }

    .progress-value {
        font-size: 14px;
        font-weight: 700;
        color: var(--primary-dark);
    }

    .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--border-green);
        border-radius: var(--radius-sm);
        overflow: hidden;
        margin-top: 8px;
    }

    .progress-fill {
        height: 100%;
        background: var(--primary-gradient);
        border-radius: var(--radius-sm);
        transition: width 1s ease;
    }

    /* Action Buttons */
    .action-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 16px;
    }

    .action-btn {
        background: var(--green-500);
        color: white;
        border: none;
        padding: 16px 20px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 14px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-height: 48px;
    }

    .action-btn:hover {
        background: var(--green-600);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
        color: white;
        text-decoration: none;
    }

    .action-btn i {
        font-size: 16px;
    }

    .export-dropdown-wrapper {
        position: relative;
    }

    .export-dropdown {
        position: absolute;
        bottom: 100%;
        left: 50%;
        transform: translateX(-50%);
        margin-bottom: 8px;
        background: white;
        border-radius: 8px;
        box-shadow: var(--shadow-lg);
        min-width: 180px;
        z-index: 1000;
        border: 1px solid var(--card-border);
        overflow: hidden;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }

    .export-dropdown.show {
        opacity: 1;
        visibility: visible;
    }

    .export-option {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        color: var(--text-primary);
        text-decoration: none;
        transition: all 0.2s ease;
        font-weight: 500;
        font-size: 14px;
        background: transparent;
        border: none;
        width: 100%;
        text-align: left;
        cursor: pointer;
    }

    .export-option:hover {
        background: var(--gray-50);
        color: var(--text-primary);
    }

    .export-option i {
        width: 16px;
        text-align: center;
        font-size: 14px;
        color: var(--green-500);
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
        .content-grid {
            grid-template-columns: 1fr;
        }
        
        .kpi-grid {
            grid-template-columns: repeat(2, 1fr);
        }
    }

    @media (max-width: 768px) {
        .kpi-grid {
            grid-template-columns: 1fr;
        }
        
        .action-grid {
            grid-template-columns: 1fr;
        }
        
        .modern-table {
            font-size: 12px;
        }
        
        .card-body {
            padding: 16px;
        }
    }

    /* Floating Chatbot */
    .chatbot-toggle {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 60px;
        height: 60px;
        background: var(--green-500);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 24px;
        cursor: pointer;
        box-shadow: var(--shadow-lg);
        transition: all 0.3s ease;
        z-index: 1000;
        border: none;
    }

    .chatbot-toggle:hover {
        background: var(--green-600);
        transform: scale(1.1);
    }

    .chatbot-panel {
        position: fixed;
        top: 0;
        right: -400px;
        width: 400px;
        height: 100vh;
        background: white;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
        transition: right 0.3s ease;
        z-index: 999;
        display: flex;
        flex-direction: column;
    }

    .chatbot-panel.open {
        right: 0;
    }

    .chatbot-header {
        padding: 20px;
        background: var(--green-500);
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    .chatbot-close {
        background: none;
        border: none;
        color: white;
        font-size: 20px;
        cursor: pointer;
        padding: 4px;
    }

    .chatbot-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        background: var(--gray-50);
    }

    .chatbot-input-area {
        padding: 20px;
        border-top: 1px solid var(--card-border);
        background: white;
    }

    .chatbot-input-group {
        display: flex;
        gap: 8px;
    }

    .chatbot-input {
        flex: 1;
        padding: 12px;
        border: 1px solid var(--card-border);
        border-radius: 8px;
        font-size: 14px;
    }

    .chatbot-send {
        padding: 12px 16px;
        background: var(--green-500);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
    }

    .dashboard-container.chatbot-open {
        margin-right: 400px;
        transition: margin-right 0.3s ease;
    }

    .message {
        margin-bottom: 12px;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 80%;
        word-wrap: break-word;
    }

    .message.user {
        background: var(--green-500);
        color: white;
        margin-left: auto;
        text-align: right;
    }

    .message.ai {
        background: white;
        border: 1px solid var(--card-border);
        margin-right: auto;
    }

    /* Typing indicator styles */
    .typing-dots {
        display: inline-flex;
        gap: 4px;
        align-items: center;
        margin-left: 8px;
    }
    
    .typing-dots span {
        width: 6px;
        height: 6px;
        background: var(--green-500);
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }

    @media (max-width: 768px) {
        .chatbot-panel {
            width: 100vw;
            right: -100vw;
        }
        
        .dashboard-container.chatbot-open {
            margin-right: 0;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">Organization Overview</h1>
        <p class="dashboard-subtitle">Monitor and manage your organization's key metrics and user activities</p>
    </div>

    <!-- KPI Cards -->
    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Total Users</div>
                <div class="kpi-icon"><i class="fas fa-users"></i></div>
            </div>
            <div class="kpi-value">{{ user_count }}</div>
            <div class="kpi-change positive">
                <i class="fas fa-arrow-up"></i>
                {{ users_created_by_admin }} created by you
            </div>
        </div>

        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Active Users</div>
                <div class="kpi-icon"><i class="fas fa-user-check"></i></div>
            </div>
            <div class="kpi-value">{{ active_users }}</div>
            <div class="kpi-change {% if inactive_users == 0 %}positive{% else %}neutral{% endif %}">
                <i class="fas fa-{% if inactive_users == 0 %}check{% else %}info{% endif %}"></i>
                {{ inactive_users }} inactive
            </div>
        </div>



        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Profile Completion</div>
                <div class="kpi-icon"><i class="fas fa-chart-pie"></i></div>
            </div>
            <div class="kpi-value">{{ profile_completion_rate }}%</div>
            <div class="kpi-change {% if profile_completion_rate >= 80 %}positive{% else %}neutral{% endif %}">
                <i class="fas fa-{% if profile_completion_rate >= 80 %}check{% else %}clock{% endif %}"></i>
                {% if profile_completion_rate >= 80 %}Excellent{% else %}Needs attention{% endif %}
            </div>
        </div>



        <div class="kpi-card">
            <div class="kpi-header">
                <div class="kpi-title">Documents</div>
                <div class="kpi-icon"><i class="fas fa-file-alt"></i></div>
            </div>
            <div class="kpi-value">{{ total_documents }}</div>
            <div class="kpi-change {% if pending_documents == 0 %}positive{% else %}neutral{% endif %}">
                <i class="fas fa-shield-alt"></i>
                {{ verified_documents }} verified
            </div>
        </div>
    </div>

    <!-- Analytics Section -->
    {% if has_vehicle_data %}
    <div class="modern-card" style="margin-bottom: 40px;">
        <div class="card-header">
            <h3 class="card-title">Vehicle Analytics Overview</h3>
        </div>
        <div class="card-body">
            <!-- Filters Section -->
            <div style="background: var(--gray-50); padding: 20px; border-radius: 8px; margin-bottom: 32px;">
                <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Filters</h4>
                <form method="GET" id="filterForm" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; align-items: end;">
                    <div>
                        <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; display: block;">Month</label>
                        <select name="month" class="filter-select" style="width: 100%; padding: 8px; border: 1px solid var(--card-border); border-radius: 6px; font-size: 14px;">
                            <option value="">All Months</option>
                            {% for month in filter_options.months %}
                                <option value="{{ month.value }}" {% if applied_filters.month == month.value|stringformat:"s" %}selected{% endif %}>{{ month.label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; display: block;">Vehicle Type</label>
                        <select name="vehicle_type" class="filter-select" style="width: 100%; padding: 8px; border: 1px solid var(--card-border); border-radius: 6px; font-size: 14px;">
                            <option value="">All Types</option>
                            {% for type in filter_options.vehicle_types %}
                                <option value="{{ type }}" {% if applied_filters.vehicle_type == type %}selected{% endif %}>{{ type }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; display: block;">Vehicle Brand</label>
                        <select name="vehicle_brand" class="filter-select" style="width: 100%; padding: 8px; border: 1px solid var(--card-border); border-radius: 6px; font-size: 14px;">
                            <option value="">All Brands</option>
                            {% for brand in filter_options.vehicle_brands %}
                                <option value="{{ brand }}" {% if applied_filters.vehicle_brand == brand %}selected{% endif %}>{{ brand }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; display: block;">Payment Method</label>
                        <select name="payment_method" class="filter-select" style="width: 100%; padding: 8px; border: 1px solid var(--card-border); border-radius: 6px; font-size: 14px;">
                            <option value="">All Methods</option>
                            {% for method in filter_options.payment_methods %}
                                <option value="{{ method }}" {% if applied_filters.payment_method == method %}selected{% endif %}>{{ method }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; display: block;">Plate Color</label>
                        <select name="plate_color" class="filter-select" style="width: 100%; padding: 8px; border: 1px solid var(--card-border); border-radius: 6px; font-size: 14px;">
                            <option value="">All Colors</option>
                            {% for color in filter_options.plate_colors %}
                                <option value="{{ color }}" {% if applied_filters.plate_color == color %}selected{% endif %}>{{ color }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 12px; font-weight: 500; color: var(--text-secondary); margin-bottom: 4px; display: block;">Year</label>
                        <select name="year" class="filter-select" style="width: 100%; padding: 8px; border: 1px solid var(--card-border); border-radius: 6px; font-size: 14px;">
                            <option value="">All Years</option>
                            {% for year in filter_options.years %}
                                <option value="{{ year }}" {% if applied_filters.year == year|stringformat:"s" %}selected{% endif %}>{{ year }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button type="submit" style="padding: 8px 16px; background: var(--green-500); color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">Apply</button>
                        <button type="button" id="resetFilters" style="padding: 8px 16px; background: var(--gray-100); color: var(--text-secondary); border: 1px solid var(--card-border); border-radius: 6px; font-weight: 500; cursor: pointer;">Reset</button>
                    </div>
                </form>
            </div>
            <!-- Fleet Summary KPIs -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px;">
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">{{ fleet_summary.total_vehicles }}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Total Vehicles</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">{{ fleet_summary.utilization_rate|floatformat:1 }}%</div>
                    <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Utilization Rate</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">{{ fleet_summary.active_vehicles }}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Active Vehicles</div>
                </div>
                <div style="text-align: center; padding: 16px; background: var(--gray-50); border-radius: 8px;">
                    <div style="font-size: 24px; font-weight: 700; color: var(--text-primary); margin-bottom: 4px;">{{ fleet_summary.avg_parking_duration|floatformat:0 }}</div>
                    <div style="font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em;">Avg Parking (Min)</div>
                </div>
            </div>
            
            <!-- Charts Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Parking Duration Analysis</h4>
                    {% if org_parking_duration_chart %}
                        <div id="orgParkingDurationChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-clock" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No parking duration data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Hourly Vehicle Entries</h4>
                    {% if org_hourly_entries_chart %}
                        <div id="orgHourlyEntriesChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-clock" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No hourly entry data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Vehicles that Visited Organization</h4>
                    {% if org_vehicles_count_chart %}
                        <div id="orgVehiclesCountChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-car" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No vehicle data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Revenue Analysis</h4>
                    {% if org_revenue_analysis_chart %}
                        <div id="orgRevenueAnalysisChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-money-bill-wave" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No revenue data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Additional Chart Row -->
            <div style="display: grid; grid-template-columns: 1fr; gap: 24px; margin-bottom: 24px;">
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Average Stay by Vehicle Type</h4>
                    {% if org_avg_stay_by_type_chart %}
                        <div id="orgAvgStayByTypeChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-clock" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No stay duration data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Business Intelligence Charts -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Capacity Utilization</h4>
                    {% if org_capacity_utilization_chart %}
                        <div id="orgCapacityUtilizationChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-chart-bar" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No capacity data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Top Customer Analysis</h4>
                    {% if org_customer_loyalty_chart %}
                        <div id="orgCustomerLoyaltyChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-users" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No customer data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Revenue Trends</h4>
                    {% if org_revenue_trends_chart %}
                        <div id="orgRevenueTrendsChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-trending-up" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No trend data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Advanced Analytics Charts -->
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; margin-bottom: 24px;">
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Payment Methods Analysis</h4>
                    {% if org_payment_behavior_chart %}
                        <div id="orgPaymentBehaviorChart" style="height: 350px;"></div>
                    {% else %}
                        <div style="height: 350px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-credit-card" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No payment data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Vehicle Brand Performance</h4>
                    {% if org_vehicle_brand_performance_chart %}
                        <div id="orgVehicleBrandPerformanceChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-car" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No brand data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
                <div>
                    <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Seasonal Patterns</h4>
                    {% if org_seasonal_patterns_chart %}
                        <div id="orgSeasonalPatternsChart" style="height: 300px;"></div>
                    {% else %}
                        <div style="height: 300px; display: flex; align-items: center; justify-content: center; background: var(--gray-50); border-radius: 8px; color: var(--text-muted);">
                            <div style="text-align: center;">
                                <i class="fas fa-calendar" style="font-size: 32px; margin-bottom: 8px;"></i>
                                <p>No seasonal data available</p>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Top Routes -->
            {% if route_analysis %}
            <div>
                <h4 style="font-size: 16px; font-weight: 600; color: var(--text-primary); margin-bottom: 16px;">Top Routes</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
                    {% for route in route_analysis %}
                    <div style="padding: 12px 16px; background: var(--gray-50); border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; color: var(--text-primary); font-size: 14px;">{{ route.route }}</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">{{ route.avg_distance|floatformat:1 }} km avg</div>
                        </div>
                        <div style="font-weight: 700; color: var(--green-600);">{{ route.frequency }}</div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <div style="text-align: center; margin-top: 24px;">
                <a href="{% url 'analytics' %}" class="action-btn" style="display: inline-flex;">
                    <i class="fas fa-chart-bar"></i>
                    View Full Analytics
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Content Grid -->
    <div class="content-grid">
        <!-- Main Content Area -->
        <div class="main-content-area">
            <!-- Users Table -->
            <div class="modern-card">
                <div class="card-header">
                    <h3 class="card-title">Organization Users ({{ user_count }})</h3>
                </div>
                <div class="card-body">
                    {% if users %}
                    <div style="overflow-x: auto;">
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Status</th>
                                    <th>Joined</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>
                                        <div class="user-info">
                                            <div class="user-avatar">
                                                {{ user.first_name|first|upper|default:"U" }}{{ user.last_name|first|upper|default:"" }}
                                            </div>
                                            <div class="user-details">
                                                <div class="user-name">{{ user.get_full_name|default:user.username }}</div>
                                                <div class="user-meta">{{ user.email }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge badge-info">{{ user.get_role_display }}</span></td>
                                    <td>{{ user.department|default:"-" }}</td>
                                    <td>
                                        {% if user.is_active %}
                                            <span class="badge badge-success">Active</span>
                                        {% else %}
                                            <span class="badge badge-warning">Inactive</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ user.date_joined|date:"M d, Y" }}</td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{% url 'edit_user' user.id %}" class="btn-sm btn-outline" title="Edit User">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="{% url 'reset_user_password' user.id %}" class="btn-sm btn-outline" title="Reset Password">
                                                <i class="fas fa-key"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 60px 20px;">
                        <i class="fas fa-users" style="font-size: 48px; color: var(--text-muted); margin-bottom: 16px;"></i>
                        <h4 style="color: var(--text-secondary); margin-bottom: 8px; font-weight: 600;">No Users Yet</h4>
                        <p style="color: var(--text-muted); margin-bottom: 24px;">Start building your team by adding your first user.</p>
                        <a href="{% url 'add_user' %}" class="action-btn">
                            <i class="fas fa-plus"></i>
                            Add First User
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar Content -->
        <div class="sidebar-content">
            <!-- Role Distribution -->
            <div class="modern-card">
                <div class="card-header">
                    <h3 class="card-title">Role Distribution</h3>
                </div>
                <div class="card-body">
                    {% if role_distribution %}
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        {% for role, count in role_distribution.items %}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: var(--text-primary);">{{ role }}</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 60px; height: 6px; background: var(--gray-100); border-radius: 3px; overflow: hidden;">
                                    <div style="width: {% widthratio count user_count 100 %}%; height: 100%; background: var(--green-500);"></div>
                                </div>
                                <span style="font-weight: 600; color: var(--text-primary); min-width: 20px;">{{ count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-chart-pie" style="font-size: 32px; color: var(--text-muted); margin-bottom: 8px;"></i>
                        <p style="color: var(--text-muted); font-size: 14px;">No role data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Department Distribution -->
            <div class="modern-card">
                <div class="card-header">
                    <h3 class="card-title">Departments</h3>
                </div>
                <div class="card-body">
                    {% if dept_distribution %}
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        {% for dept, count in dept_distribution.items %}
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500; color: var(--text-primary);">{{ dept|title }}</span>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 60px; height: 6px; background: var(--gray-100); border-radius: 3px; overflow: hidden;">
                                    <div style="width: {% widthratio count user_count 100 %}%; height: 100%; background: var(--green-500);"></div>
                                </div>
                                <span style="font-weight: 600; color: var(--text-primary); min-width: 20px;">{{ count }}</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-building" style="font-size: 32px; color: var(--text-muted); margin-bottom: 8px;"></i>
                        <p style="color: var(--text-muted); font-size: 14px;">No department data available</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Users Needing Attention -->
            <div class="modern-card">
                <div class="card-header">
                    <h3 class="card-title">Attention Required ({{ users_needing_attention|length }})</h3>
                </div>
                <div class="card-body">
                    {% if users_needing_attention %}
                    <div style="max-height: 300px; overflow-y: auto;">
                        {% for item in users_needing_attention %}
                        <div style="display: flex; align-items: flex-start; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--card-border);">
                            <div style="width: 32px; height: 32px; background: #f59e0b; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 12px; flex-shrink: 0;">
                                {{ item.user.first_name|first|upper|default:"U" }}{{ item.user.last_name|first|upper|default:"" }}
                            </div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 600; color: var(--text-primary); font-size: 14px; margin-bottom: 4px;">
                                    {{ item.user.get_full_name|default:item.user.username }}
                                </div>
                                <ul style="list-style: none; margin: 0; padding: 0;">
                                    {% for issue in item.issues %}
                                    <li style="font-size: 12px; color: var(--text-secondary); margin-bottom: 2px; position: relative; padding-left: 12px;">
                                        <span style="position: absolute; left: 0; color: #f59e0b;">â€¢</span>
                                        {{ issue }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div style="text-align: center; padding: 20px;">
                        <i class="fas fa-check-circle" style="font-size: 32px; color: var(--green-500); margin-bottom: 8px;"></i>
                        <p style="color: var(--text-muted); font-size: 14px;">All profiles are complete!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>



    <!-- Quick Actions -->
    <div class="modern-card">
        <div class="card-header">
            <h3 class="card-title">Quick Actions</h3>
        </div>
        <div class="card-body">
            <div class="action-grid">
                <a href="{% url 'add_user' %}" class="action-btn">
                    <i class="fas fa-user-plus"></i>
                    Add New User
                </a>

                <div class="export-dropdown-wrapper">
                    <button class="action-btn" id="exportBtn" type="button">
                        <i class="fas fa-file-export"></i>
                        Export Report
                    </button>
                    <div class="export-dropdown" id="exportDropdown">
                        <a href="{% url 'export_org_admin_report' %}?format=csv" class="export-option">
                            <i class="fas fa-file-csv"></i>
                            <span>Export as CSV</span>
                        </a>
                        <a href="{% url 'export_org_admin_report' %}?format=pdf" class="export-option">
                            <i class="fas fa-file-pdf"></i>
                            <span>Export as PDF</span>
                        </a>
                    </div>
                </div>

                <a href="{% url 'settings' %}" class="action-btn">
                    <i class="fas fa-cog"></i>
                    Settings
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Floating Chatbot -->
<button class="chatbot-toggle" id="chatbotToggle">
    <i class="fas fa-robot"></i>
</button>

<div class="chatbot-panel" id="chatbotPanel">
    <div class="chatbot-header">
        <div>
            <h4 style="margin: 0; font-size: 18px;">AI Assistant</h4>
            <small style="opacity: 0.9;">Ask me about your organization</small>
        </div>
        <button class="chatbot-close" id="chatbotClose">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <div class="chatbot-messages" id="chatbotMessages">
        <div class="message ai">
            <i class="fas fa-robot" style="margin-right: 8px; color: var(--green-500);"></i>
            Hello! I'm your AI assistant. I can help you with analytics, user management, and answer questions about your organization.
        </div>
    </div>
    
    <div class="chatbot-input-area">
        <div class="chatbot-input-group">
            <input type="text" class="chatbot-input" id="chatbotInput" placeholder="Ask me anything...">
            <button class="chatbot-send" id="chatbotSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animate progress bars
    const progressBars = document.querySelectorAll('.progress-fill');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 500);
    });

    // Animate stat numbers
    const statNumbers = document.querySelectorAll('.stat-number');
    statNumbers.forEach(stat => {
        const finalValue = parseInt(stat.textContent);
        if (isNaN(finalValue)) return;
        
        let currentValue = 0;
        const increment = finalValue / 50;
        const timer = setInterval(() => {
            currentValue += increment;
            if (currentValue >= finalValue) {
                stat.textContent = finalValue;
                clearInterval(timer);
            } else {
                stat.textContent = Math.floor(currentValue);
            }
        }, 30);
    });

    // Add hover effects to cards
    const cards = document.querySelectorAll('.dashboard-card, .stat-card');
    cards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-5px)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });

    // Export dropdown functionality
    const exportBtn = document.getElementById('exportBtn');
    const exportDropdown = document.getElementById('exportDropdown');
    let isExportDropdownOpen = false;

    if (exportBtn && exportDropdown) {
        exportBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            isExportDropdownOpen = !isExportDropdownOpen;
            exportDropdown.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (isExportDropdownOpen && !exportBtn.contains(e.target) && !exportDropdown.contains(e.target)) {
                isExportDropdownOpen = false;
                exportDropdown.classList.remove('show');
            }
        });

        // Close dropdown when pressing escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && isExportDropdownOpen) {
                isExportDropdownOpen = false;
                exportDropdown.classList.remove('show');
            }
        });
    }

    // Render analytics charts
    {% if has_vehicle_data %}
    // Render organization-specific analytics charts
    {% if org_parking_duration_chart %}
    try {
        const orgParkingDurationData = {{ org_parking_duration_chart|safe }};
        Plotly.newPlot('orgParkingDurationChart', orgParkingDurationData.data, orgParkingDurationData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org parking duration chart:', e);
    }
    {% endif %}
    
    {% if org_hourly_entries_chart %}
    try {
        const orgHourlyEntriesData = {{ org_hourly_entries_chart|safe }};
        Plotly.newPlot('orgHourlyEntriesChart', orgHourlyEntriesData.data, orgHourlyEntriesData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org hourly entries chart:', e);
    }
    {% endif %}
    
    {% if org_vehicles_count_chart %}
    try {
        const orgVehiclesCountData = {{ org_vehicles_count_chart|safe }};
        Plotly.newPlot('orgVehiclesCountChart', orgVehiclesCountData.data, orgVehiclesCountData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org vehicles count chart:', e);
    }
    {% endif %}
    
    {% if org_revenue_analysis_chart %}
    try {
        const orgRevenueAnalysisData = {{ org_revenue_analysis_chart|safe }};
        Plotly.newPlot('orgRevenueAnalysisChart', orgRevenueAnalysisData.data, orgRevenueAnalysisData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org revenue analysis chart:', e);
    }
    {% endif %}
    
    {% if org_avg_stay_by_type_chart %}
    try {
        const orgAvgStayByTypeData = {{ org_avg_stay_by_type_chart|safe }};
        Plotly.newPlot('orgAvgStayByTypeChart', orgAvgStayByTypeData.data, orgAvgStayByTypeData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org avg stay by type chart:', e);
    }
    {% endif %}
    
    {% if org_capacity_utilization_chart %}
    try {
        const orgCapacityUtilizationData = {{ org_capacity_utilization_chart|safe }};
        Plotly.newPlot('orgCapacityUtilizationChart', orgCapacityUtilizationData.data, orgCapacityUtilizationData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org capacity utilization chart:', e);
    }
    {% endif %}
    
    {% if org_customer_loyalty_chart %}
    try {
        const orgCustomerLoyaltyData = {{ org_customer_loyalty_chart|safe }};
        Plotly.newPlot('orgCustomerLoyaltyChart', orgCustomerLoyaltyData.data, orgCustomerLoyaltyData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org customer loyalty chart:', e);
    }
    {% endif %}
    
    {% if org_revenue_trends_chart %}
    try {
        const orgRevenueTrendsData = {{ org_revenue_trends_chart|safe }};
        Plotly.newPlot('orgRevenueTrendsChart', orgRevenueTrendsData.data, orgRevenueTrendsData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org revenue trends chart:', e);
    }
    {% endif %}
    
    {% if org_operational_efficiency_chart %}
    try {
        const orgOperationalEfficiencyData = {{ org_operational_efficiency_chart|safe }};
        Plotly.newPlot('orgOperationalEfficiencyChart', orgOperationalEfficiencyData.data, orgOperationalEfficiencyData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org operational efficiency chart:', e);
    }
    {% endif %}
    
    {% if org_payment_behavior_chart %}
    try {
        const orgPaymentBehaviorData = {{ org_payment_behavior_chart|safe }};
        Plotly.newPlot('orgPaymentBehaviorChart', orgPaymentBehaviorData.data, orgPaymentBehaviorData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org payment behavior chart:', e);
    }
    {% endif %}
    
    {% if org_vehicle_brand_performance_chart %}
    try {
        const orgVehicleBrandPerformanceData = {{ org_vehicle_brand_performance_chart|safe }};
        Plotly.newPlot('orgVehicleBrandPerformanceChart', orgVehicleBrandPerformanceData.data, orgVehicleBrandPerformanceData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org vehicle brand performance chart:', e);
    }
    {% endif %}
    
    {% if org_seasonal_patterns_chart %}
    try {
        const orgSeasonalPatternsData = {{ org_seasonal_patterns_chart|safe }};
        Plotly.newPlot('orgSeasonalPatternsChart', orgSeasonalPatternsData.data, orgSeasonalPatternsData.layout, {
            responsive: true,
            displayModeBar: false
        });
    } catch (e) {
        console.error('Error rendering org seasonal patterns chart:', e);
    }
    {% endif %}
    {% endif %}

    // Filter functionality
    const filterSelects = document.querySelectorAll('.filter-select');
    const resetFiltersBtn = document.getElementById('resetFilters');
    
    if (resetFiltersBtn) {
        resetFiltersBtn.addEventListener('click', function() {
            filterSelects.forEach(select => select.value = '');
            document.getElementById('filterForm').submit();
        });
    }
    
    // Auto-submit on filter change
    filterSelects.forEach(select => {
        select.addEventListener('change', function() {
            document.getElementById('filterForm').submit();
        });
    });

    // Advanced AI Chatbot functionality
    const chatbotToggle = document.getElementById('chatbotToggle');
    const chatbotPanel = document.getElementById('chatbotPanel');
    const chatbotClose = document.getElementById('chatbotClose');
    const chatbotInput = document.getElementById('chatbotInput');
    const chatbotSend = document.getElementById('chatbotSend');
    const chatbotMessages = document.getElementById('chatbotMessages');
    const dashboardContainer = document.querySelector('.dashboard-container');

    function toggleChatbot() {
        chatbotPanel.classList.toggle('open');
        dashboardContainer.classList.toggle('chatbot-open');
        if (chatbotPanel.classList.contains('open')) {
            chatbotInput.focus();
        }
    }

    function addChatMessage(message, isUser = false, isSmall = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'ai'}`;
        
        if (!isUser) {
            messageDiv.innerHTML = `<i class="fas fa-robot" style="margin-right: 8px; color: var(--green-500);"></i>${message}`;
        } else {
            messageDiv.textContent = message;
        }
        
        if (isSmall) {
            messageDiv.style.fontSize = '12px';
            messageDiv.style.opacity = '0.8';
        }
        
        chatbotMessages.appendChild(messageDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    function addTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai typing-indicator';
        typingDiv.innerHTML = `
            <i class="fas fa-robot" style="margin-right: 8px; color: var(--green-500);"></i>
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        `;
        chatbotMessages.appendChild(typingDiv);
        chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
    }

    function removeTypingIndicator() {
        const typing = document.querySelector('.typing-indicator');
        if (typing) typing.remove();
    }

    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name="csrf-token"]')?.content || '';
    }

    function sendChatMessage() {
        const message = chatbotInput.value.trim();
        if (!message) return;

        addChatMessage(message, true);
        chatbotInput.value = '';
        chatbotSend.disabled = true;

        // Show typing indicator
        addTypingIndicator();

        // Send to AI API
        fetch('/api/ai-chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                message: message,
                page_type: 'org_admin_dashboard',
                filters: {}
            })
        })
        .then(response => response.json())
        .then(data => {
            removeTypingIndicator();
            if (data.success) {
                addChatMessage(data.response);
                if (data.source === 'openai') {
                    addChatMessage('ðŸ’¡ Powered by OpenAI GPT', false, true);
                }
            } else {
                addChatMessage('Sorry, I encountered an error. Please try again.');
            }
        })
        .catch(error => {
            removeTypingIndicator();
            console.error('AI Chat Error:', error);
            // Enhanced fallback responses for org admin
            const response = getOrgAdminAIResponse(message);
            addChatMessage(response);
        })
        .finally(() => {
            chatbotSend.disabled = false;
        });
    }

    function getOrgAdminAIResponse(message) {
        const lowerMessage = message.toLowerCase();
        const userCount = document.querySelector('.kpi-value')?.textContent || '0';
        
        if (lowerMessage.includes('summary') || lowerMessage.includes('overview')) {
            return `Organization Summary: You manage ${userCount} users in your organization. I can provide insights on user activity, role distribution, profile completion rates, and generate detailed management reports.`;
        }
        if (lowerMessage.includes('users') || lowerMessage.includes('employees')) {
            return `User Management: Your organization has ${userCount} users. I can help analyze user activity patterns, identify users needing attention, track profile completion, and suggest user engagement strategies.`;
        }
        if (lowerMessage.includes('report') || lowerMessage.includes('analytics')) {
            return 'I can generate comprehensive reports including user activity analysis, role distribution, department analytics, and profile completion tracking. Would you like me to create a detailed management report?';
        }
        if (lowerMessage.includes('recommendation') || lowerMessage.includes('optimize')) {
            return 'Optimization Recommendations: Focus on completing incomplete profiles, engage inactive users, balance role distribution, and implement regular user activity monitoring for better organizational efficiency.';
        }
        if (lowerMessage.includes('vehicle') || lowerMessage.includes('fleet')) {
            return 'Fleet Analytics: I can analyze your organization\'s vehicle usage patterns, parking trends, revenue generation, and provide fleet optimization recommendations based on the data shown in your analytics section.';
        }
        if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
            return 'I can help with: User management insights, organizational analytics, fleet performance analysis, report generation, optimization recommendations, and answering questions about your dashboard metrics. What would you like to explore?';
        }
        
        return `I can provide insights about your organization's ${userCount} users, analyze performance metrics, generate reports, and help with user management decisions. What specific aspect would you like me to analyze?`;
    }

    if (chatbotToggle) {
        chatbotToggle.addEventListener('click', toggleChatbot);
    }

    if (chatbotClose) {
        chatbotClose.addEventListener('click', toggleChatbot);
    }

    if (chatbotSend) {
        chatbotSend.addEventListener('click', sendChatMessage);
    }

    if (chatbotInput) {
        chatbotInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    }

    // Close chatbot when clicking outside
    document.addEventListener('click', function(e) {
        if (chatbotPanel.classList.contains('open') && 
            !chatbotPanel.contains(e.target) && 
            !chatbotToggle.contains(e.target)) {
            toggleChatbot();
        }
    });

    // Close chatbot on escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && chatbotPanel.classList.contains('open')) {
            toggleChatbot();
        }
    });
});
</script>
{% endblock %}