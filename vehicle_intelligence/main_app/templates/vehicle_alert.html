{% extends 'base.html' %}

{% block title %}Vehicle Alert - Vehicle Intelligence System{% endblock %}

{% block content %}
<div class="main-content">
    <div class="content-header">
        <h1 class="page-title">Vehicle Alert System</h1>
        <p class="page-subtitle">Search and analyze specific vehicle data</p>
    </div>

    <div class="content-body">
        <!-- Search Section -->
        <div class="search-section">
            <div class="search-header">
                <h2><i class="fas fa-search"></i> Vehicle Search</h2>
                <p>Enter vehicle license plate or VIN to view detailed analytics</p>
            </div>
            
            <form method="GET" class="search-form">
                <div class="search-input-group">
                    <input type="text" 
                           name="search" 
                           value="{{ search_query }}" 
                           placeholder="Enter license plate or VIN (e.g., KCA 123A)"
                           class="search-input"
                           required>
                    <button type="submit" class="search-btn">
                        <i class="fas fa-search"></i>
                        Search Vehicle
                    </button>
                </div>
            </form>
        </div>

        {% if search_query and not vehicle_data %}
        <!-- No Results -->
        <div class="no-results">
            <div class="no-results-icon">
                <i class="fas fa-car-crash"></i>
            </div>
            <h3>Vehicle Not Found</h3>
            <p>No vehicle found with license plate or VIN: <strong>{{ search_query }}</strong></p>
            <p>Please check the spelling and try again.</p>
        </div>
        {% endif %}

        {% if vehicle_data %}
        <!-- Vehicle Analytics -->
        <div class="vehicle-analytics">
            <!-- Vehicle Info Header -->
            <div class="vehicle-header">
                <div class="vehicle-info">
                    <h2>{{ vehicle_data.vehicle.make }} {{ vehicle_data.vehicle.model }}</h2>
                    <div class="vehicle-details">
                        <span class="detail-item">
                            <i class="fas fa-id-card"></i>
                            License: {{ vehicle_data.vehicle.license_plate }}
                        </span>
                        <span class="detail-item">
                            <i class="fas fa-barcode"></i>
                            VIN: {{ vehicle_data.vehicle.vin }}
                        </span>
                        <span class="detail-item">
                            <i class="fas fa-building"></i>
                            Organization: {{ vehicle_data.organization }}
                        </span>
                        <span class="detail-item">
                            <i class="fas fa-calendar"></i>
                            Year: {{ vehicle_data.vehicle.year }}
                        </span>
                    </div>
                </div>
                <div class="vehicle-status">
                    <span class="status-badge status-{{ vehicle_data.status|lower }}">
                        {{ vehicle_data.status }}
                    </span>
                    <p class="last-seen">
                        Last seen: {{ vehicle_data.last_seen|timesince }} ago
                    </p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-route"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ vehicle_data.total_trips }}</h3>
                        <p>Total Trips</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-road"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ vehicle_data.total_distance }} km</h3>
                        <p>Total Distance</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-gas-pump"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ vehicle_data.total_fuel }} L</h3>
                        <p>Fuel Consumed</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-tachometer-alt"></i>
                    </div>
                    <div class="stat-content">
                        <h3>{{ vehicle_data.avg_speed }} km/h</h3>
                        <p>Average Speed</p>
                    </div>
                </div>
            </div>

            <!-- Detailed Analytics -->
            <div class="analytics-grid">
                <!-- Current Location -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3><i class="fas fa-map-marker-alt"></i> Current Location</h3>
                    </div>
                    <div class="card-content">
                        <div class="location-info">
                            <h4>{{ vehicle_data.last_location }}</h4>
                            <p>Last updated: {{ vehicle_data.last_seen|timesince }} ago</p>
                        </div>
                        <div class="location-map">
                            <div id="map" style="height: 300px; width: 100%; border-radius: 8px;"></div>
                        </div>
                    </div>
                </div>

                <!-- Monthly Performance -->
                <div class="analytics-card">
                    <div class="card-header">
                        <h3><i class="fas fa-chart-line"></i> Monthly Performance</h3>
                    </div>
                    <div class="card-content">
                        <div class="performance-metrics">
                            <div class="metric">
                                <span class="metric-label">Trips This Month</span>
                                <span class="metric-value">{{ vehicle_data.monthly_trips }}</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Distance This Month</span>
                                <span class="metric-value">{{ vehicle_data.monthly_distance }} km</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Fuel Efficiency</span>
                                <span class="metric-value">{{ vehicle_data.fuel_efficiency }} km/L</span>
                            </div>
                            <div class="metric">
                                <span class="metric-label">Maintenance Status</span>
                                <span class="metric-value status-{{ vehicle_data.maintenance_due|yesno:'due,ok' }}">
                                    {% if vehicle_data.maintenance_due %}Due{% else %}Up to Date{% endif %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Trips -->
            <div class="recent-trips">
                <div class="section-header">
                    <h3><i class="fas fa-history"></i> Recent Trips</h3>
                </div>
                <div class="trips-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>From</th>
                                <th>To</th>
                                <th>Distance</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trip in vehicle_data.recent_trips %}
                            <tr>
                                <td>{{ trip.date }}</td>
                                <td>{{ trip.from }}</td>
                                <td>{{ trip.to }}</td>
                                <td>{{ trip.distance }} km</td>
                                <td>{{ trip.duration }} min</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if not search_query %}
        <!-- Instructions -->
        <div class="instructions">
            <div class="instruction-card">
                <div class="instruction-icon">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div class="instruction-content">
                    <h3>How to Use Vehicle Alert</h3>
                    <ul>
                        <li>Enter a vehicle license plate or VIN in the search box above</li>
                        <li>Click "Search Vehicle" to find the vehicle in the system</li>
                        <li>View comprehensive analytics including trips, fuel consumption, and location data</li>
                        <li>Monitor vehicle performance and maintenance status</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<style>
.main-content {
    transition: margin-right 0.3s ease;
}

.main-content.chat-open {
    margin-right: 380px;
}

.search-section {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.search-header {
    text-align: center;
    margin-bottom: 2rem;
}

.search-header h2 {
    color: #111827;
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.search-header p {
    color: #6b7280;
    font-size: 1rem;
}

.search-input-group {
    display: flex;
    gap: 1rem;
    max-width: 600px;
    margin: 0 auto;
}

.search-input {
    flex: 1;
    padding: 1rem 1.5rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    font-size: 1rem;
    transition: border-color 0.2s;
}

.search-input:focus {
    outline: none;
    border-color: #16a34a;
}

.search-btn {
    padding: 1rem 2rem;
    background: #16a34a;
    color: white;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.search-btn:hover {
    background: #15803d;
}

.no-results {
    text-align: center;
    padding: 3rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.no-results-icon {
    font-size: 4rem;
    color: #ef4444;
    margin-bottom: 1rem;
}

.vehicle-header {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.vehicle-info h2 {
    color: #111827;
    font-size: 1.75rem;
    font-weight: 700;
    margin-bottom: 1rem;
}

.vehicle-details {
    display: flex;
    gap: 2rem;
    flex-wrap: wrap;
}

.detail-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #6b7280;
    font-size: 0.95rem;
}

.detail-item i {
    color: #16a34a;
}

.vehicle-status {
    text-align: right;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    font-size: 0.875rem;
}

.status-active {
    background: #dcfce7;
    color: #166534;
}

.last-seen {
    color: #6b7280;
    font-size: 0.875rem;
    margin-top: 0.5rem;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 1.5rem;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 1rem;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.stat-icon {
    width: 50px;
    height: 50px;
    background: #f0fdf4;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #16a34a;
    font-size: 1.25rem;
}

.stat-content h3 {
    font-size: 1.5rem;
    font-weight: 700;
    color: #111827;
    margin: 0 0 0.25rem 0;
}

.stat-content p {
    color: #6b7280;
    margin: 0;
    font-size: 0.875rem;
}

.analytics-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.analytics-card {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.card-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
}

.card-header h3 {
    color: #111827;
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-content {
    padding: 1.5rem;
}

.location-info h4 {
    color: #111827;
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

.map-placeholder {
    background: #f3f4f6;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    color: #6b7280;
    margin-top: 1rem;
}

.map-placeholder i {
    font-size: 2rem;
    margin-bottom: 0.5rem;
}

.performance-metrics {
    display: grid;
    gap: 1rem;
}

.metric {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 0;
    border-bottom: 1px solid #f3f4f6;
}

.metric:last-child {
    border-bottom: none;
}

.metric-label {
    color: #6b7280;
    font-size: 0.875rem;
}

.metric-value {
    font-weight: 600;
    color: #111827;
}

.metric-value.status-ok {
    color: #16a34a;
}

.metric-value.status-due {
    color: #dc2626;
}

.recent-trips {
    background: white;
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.section-header {
    padding: 1.5rem;
    border-bottom: 1px solid #e5e7eb;
    background: #f9fafb;
}

.section-header h3 {
    color: #111827;
    font-size: 1.125rem;
    font-weight: 600;
    margin: 0;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.trips-table {
    overflow-x: auto;
}

.trips-table table {
    width: 100%;
    border-collapse: collapse;
}

.trips-table th,
.trips-table td {
    padding: 1rem 1.5rem;
    text-align: left;
    border-bottom: 1px solid #f3f4f6;
}

.trips-table th {
    background: #f9fafb;
    font-weight: 600;
    color: #374151;
    font-size: 0.875rem;
}

.instructions {
    background: white;
    padding: 2rem;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.instruction-card {
    display: flex;
    gap: 1.5rem;
    align-items: flex-start;
}

.instruction-icon {
    font-size: 2rem;
    color: #16a34a;
    flex-shrink: 0;
}

.instruction-content h3 {
    color: #111827;
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.instruction-content ul {
    color: #6b7280;
    line-height: 1.6;
}

.instruction-content li {
    margin-bottom: 0.5rem;
}

@media (max-width: 768px) {
    .search-input-group {
        flex-direction: column;
    }
    
    .vehicle-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .vehicle-details {
        justify-content: center;
    }
    
    .analytics-grid {
        grid-template-columns: 1fr;
    }
    
    .instruction-card {
        flex-direction: column;
        text-align: center;
    }
    
    .main-content.chat-open {
        margin-right: 0;
    }
    
    .ai-assistant-float {
        width: 56px;
        height: 56px;
        bottom: 20px;
        right: 20px;
    }
    
    .ai-assistant-float i {
        font-size: 24px;
    }
    
    .ai-tooltip {
        display: none;
    }
    
    .ai-chat-modal {
        width: calc(100vw - 20px);
        height: 350px;
        right: 10px;
        bottom: 80px;
        top: auto;
    }
}

/* AI Assistant Styles */
.ai-assistant-float {
    position: fixed;
    bottom: 24px;
    right: 24px;
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, #16a34a, #15803d);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 8px 24px rgba(22, 163, 74, 0.3);
    transition: all 0.3s ease;
    z-index: 1000;
    border: 3px solid white;
}

.ai-assistant-float:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 32px rgba(22, 163, 74, 0.4);
    background: linear-gradient(135deg, #15803d, #166534);
}

.ai-assistant-float i {
    font-size: 28px;
    color: white;
    animation: pulse 2s infinite;
}

.ai-tooltip {
    position: absolute;
    right: 80px;
    top: 50%;
    transform: translateY(-50%);
    background: #111827;
    color: white;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    pointer-events: none;
}

.ai-tooltip::after {
    content: '';
    position: absolute;
    left: 100%;
    top: 50%;
    transform: translateY(-50%);
    border: 6px solid transparent;
    border-left-color: #111827;
}

.ai-assistant-float:hover .ai-tooltip {
    opacity: 1;
    visibility: visible;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
}

.ai-chat-modal {
    position: fixed;
    top: 0;
    right: 0;
    width: 380px;
    height: 100vh;
    background: white;
    border-left: 1px solid #e5e7eb;
    box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
    z-index: 1001;
    display: none;
    flex-direction: column;
    overflow: hidden;
    transform: translateX(100%);
    transition: transform 0.3s ease;
}

.ai-chat-modal.show {
    display: flex;
    transform: translateX(0);
}

.ai-chat-container {
    display: flex;
    flex-direction: column;
    height: 100%;
}

.ai-chat-header {
    padding: 16px 20px;
    background: linear-gradient(135deg, #16a34a, #15803d);
    color: white;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #e5e7eb;
}

.ai-chat-title {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 600;
    font-size: 16px;
}

.ai-chat-close {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    transition: background 0.2s ease;
}

.ai-chat-close:hover {
    background: rgba(255, 255, 255, 0.2);
}

.ai-chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 16px;
    background: #f9fafb;
}

.ai-message, .user-message {
    display: flex;
    gap: 12px;
    align-items: flex-start;
}

.user-message {
    flex-direction: row-reverse;
}

.ai-avatar, .user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    flex-shrink: 0;
}

.ai-avatar {
    background: linear-gradient(135deg, #16a34a, #15803d);
    color: white;
}

.user-avatar {
    background: #3b82f6;
    color: white;
}

.ai-message-content, .user-message-content {
    background: white;
    padding: 12px 16px;
    border-radius: 12px;
    max-width: 280px;
    font-size: 14px;
    line-height: 1.5;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    color: #111827;
    font-weight: 500;
}

.user-message-content {
    background: #3b82f6;
    color: white;
}

.ai-chat-input {
    padding: 16px 20px;
    border-top: 1px solid #e5e7eb;
    display: flex;
    gap: 12px;
    align-items: center;
    background: white;
}

.ai-chat-input input {
    flex: 1;
    padding: 12px 16px;
    border: 1px solid #e5e7eb;
    border-radius: 24px;
    font-size: 14px;
    outline: none;
}

.ai-chat-input input:focus {
    border-color: #16a34a;
    box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
}

.ai-chat-input button {
    width: 40px;
    height: 40px;
    background: #16a34a;
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.2s ease;
}

.ai-chat-input button:hover {
    background: #15803d;
}

.ai-chat-input button:disabled {
    background: #9ca3af;
    cursor: not-allowed;
}

/* Typing indicator styles */
.typing-dots {
    display: flex;
    gap: 4px;
    align-items: center;
}

.typing-dots span {
    width: 6px;
    height: 6px;
    background: #6b7280;
    border-radius: 50%;
    animation: typing 1.4s infinite ease-in-out;
}

.typing-dots span:nth-child(1) { animation-delay: -0.32s; }
.typing-dots span:nth-child(2) { animation-delay: -0.16s; }

@keyframes typing {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
}
</style>

{% if vehicle_data %}
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<script>
// Organization coordinates mapping
const organizationCoordinates = {
    'United Mall': { lat: -1.2921, lng: 36.8219, name: 'United Mall, Nairobi' },
    'Corporate Fleet': { lat: -1.2864, lng: 36.8172, name: 'Corporate Fleet HQ' },
    'Executive Transport': { lat: -1.3032, lng: 36.8073, name: 'Executive Transport' },
    'Westgate Mall': { lat: -1.2676, lng: 36.8062, name: 'Westgate Mall' },
    'Sarit Centre': { lat: -1.2630, lng: 36.8062, name: 'Sarit Centre' },
    'Village Market': { lat: -1.2420, lng: 36.8062, name: 'Village Market' },
    'Junction Mall': { lat: -1.3032, lng: 36.8219, name: 'Junction Mall' },
    'Garden City Mall': { lat: -1.3667, lng: 36.7833, name: 'Garden City Mall' },
    'Two Rivers Mall': { lat: -1.2297, lng: 36.8073, name: 'Two Rivers Mall' },
    'The Hub Karen': { lat: -1.3197, lng: 36.6854, name: 'The Hub Karen' },
    'Default': { lat: -1.2921, lng: 36.8219, name: 'Nairobi, Kenya' }
};

// Get coordinates for current location
const currentLocation = '{{ vehicle_data.last_location }}';
const coords = organizationCoordinates[currentLocation] || organizationCoordinates['Default'];

// Initialize Leaflet Map
function initMap() {
    // Create map
    const map = L.map('map').setView([coords.lat, coords.lng], 15);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
    }).addTo(map);
    
    // Custom vehicle icon
    const vehicleIcon = L.divIcon({
        html: '<div style="background: #16a34a; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 16px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üöó</div>',
        className: 'custom-vehicle-marker',
        iconSize: [36, 36],
        iconAnchor: [18, 18]
    });
    
    // Add marker for vehicle location
    const marker = L.marker([coords.lat, coords.lng], { icon: vehicleIcon }).addTo(map);
    
    // Add popup with vehicle information
    marker.bindPopup(`
        <div style="padding: 10px; font-family: Arial, sans-serif; min-width: 200px;">
            <h4 style="margin: 0 0 8px 0; color: #16a34a;">{{ vehicle_data.vehicle.make }} {{ vehicle_data.vehicle.model }}</h4>
            <p style="margin: 0 0 5px 0;"><strong>License:</strong> {{ vehicle_data.vehicle.license_plate }}</p>
            <p style="margin: 0 0 5px 0;"><strong>Location:</strong> ${coords.name}</p>
            <p style="margin: 0 0 5px 0;"><strong>Status:</strong> {{ vehicle_data.status }}</p>
            <p style="margin: 0;"><strong>Last Seen:</strong> {{ vehicle_data.last_seen|timesince }} ago</p>
        </div>
    `).openPopup();
    
    // Add circle to show approximate area
    L.circle([coords.lat, coords.lng], {
        color: '#16a34a',
        fillColor: '#16a34a',
        fillOpacity: 0.1,
        radius: 200
    }).addTo(map);
}

// Load Leaflet and initialize map
function loadMap() {
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload = initMap;
    document.head.appendChild(script);
}

// Initialize when page loads
document.addEventListener('DOMContentLoaded', loadMap);
</script>
{% endif %}

<!-- AI Assistant Floating Button -->
<div class="ai-assistant-float" id="aiAssistantBtn">
    <div class="ai-tooltip">AI Assistant - Get vehicle help!</div>
    <i class="fas fa-robot"></i>
</div>

<!-- AI Assistant Chat Modal -->
<div id="aiChatModal" class="ai-chat-modal">
    <div class="ai-chat-container">
        <div class="ai-chat-header">
            <div class="ai-chat-title">
                <i class="fas fa-robot"></i>
                <span>AI Assistant</span>
            </div>
            <button class="ai-chat-close" id="aiChatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-message-content">
                    Hello! I'm your advanced vehicle intelligence assistant. I can provide comprehensive analysis, performance insights, predictive maintenance alerts, cost optimization, and detailed reporting. Ask me for a "summary" or specific vehicle insights!
                </div>
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="Ask me about vehicle data..." maxlength="500">
            <button id="aiChatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
// AI Assistant functionality
const aiAssistantBtn = document.getElementById('aiAssistantBtn');
const aiChatModal = document.getElementById('aiChatModal');
const aiChatClose = document.getElementById('aiChatClose');
const aiChatInput = document.getElementById('aiChatInput');
const aiChatSend = document.getElementById('aiChatSend');
const aiChatMessages = document.getElementById('aiChatMessages');

function toggleAIChat() {
    aiChatModal.classList.toggle('show');
    document.querySelector('.main-content').classList.toggle('chat-open');
    if (aiChatModal.classList.contains('show')) {
        aiChatInput.focus();
    }
}

function closeAIChat() {
    aiChatModal.classList.remove('show');
    document.querySelector('.main-content').classList.remove('chat-open');
}

function sendAIMessage() {
    const message = aiChatInput.value.trim();
    if (!message) return;
    
    addMessage(message, 'user');
    aiChatInput.value = '';
    aiChatSend.disabled = true;
    
    // Show typing indicator
    addTypingIndicator();
    
    // Get current vehicle context
    const filters = getCurrentVehicleContext();
    
    // Send to AI API
    fetch('/api/ai-chat/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            message: message,
            page_type: 'vehicle_alert',
            filters: filters
        })
    })
    .then(response => response.json())
    .then(data => {
        removeTypingIndicator();
        if (data.success) {
            addMessage(data.response, 'ai');
            if (data.source === 'openai') {
                addMessage('üí° Powered by OpenAI GPT', 'ai', true);
            }
        } else {
            addMessage('Sorry, I encountered an error. Please try again.', 'ai');
        }
    })
    .catch(error => {
        removeTypingIndicator();
        console.error('AI Chat Error:', error);
        // Fallback to local response
        const response = getAIResponse(message);
        addMessage(response, 'ai');
    })
    .finally(() => {
        aiChatSend.disabled = false;
    });
}

function getCurrentVehicleContext() {
    const filters = {};
    const vehicleHeader = document.querySelector('.vehicle-header');
    if (vehicleHeader) {
        const licensePlate = document.querySelector('.detail-item')?.textContent?.split(': ')[1];
        if (licensePlate) filters.license_plate = licensePlate;
    }
    return filters;
}

function addTypingIndicator() {
    const typingDiv = document.createElement('div');
    typingDiv.className = 'ai-message typing-indicator';
    typingDiv.innerHTML = `
        <div class="ai-avatar"><i class="fas fa-robot"></i></div>
        <div class="ai-message-content">
            <div class="typing-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    `;
    aiChatMessages.appendChild(typingDiv);
    aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
}

function removeTypingIndicator() {
    const typing = document.querySelector('.typing-indicator');
    if (typing) typing.remove();
}

function getCsrfToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.content || '';
}

function addMessage(content, type, isSmall = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = type === 'user' ? 'user-message' : 'ai-message';
    
    const avatar = document.createElement('div');
    avatar.className = type === 'user' ? 'user-avatar' : 'ai-avatar';
    avatar.innerHTML = type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
    
    const messageContent = document.createElement('div');
    messageContent.className = type === 'user' ? 'user-message-content' : 'ai-message-content';
    if (isSmall) messageContent.style.fontSize = '12px';
    messageContent.textContent = content;
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(messageContent);
    
    aiChatMessages.appendChild(messageDiv);
    aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
}

function getAIResponse(message) {
    const lowerMessage = message.toLowerCase();
    
    // Advanced vehicle analysis
    if (lowerMessage.includes('summary') || lowerMessage.includes('overview')) {
        const vehicleFound = document.querySelector('.vehicle-header');
        if (vehicleFound) {
            const stats = document.querySelectorAll('.stat-content h3');
            return `Vehicle Analysis Summary: This vehicle has completed ${stats[0]?.textContent || 'N/A'} trips covering ${stats[1]?.textContent || 'N/A'} total distance. Fuel consumption: ${stats[2]?.textContent || 'N/A'}, Average speed: ${stats[3]?.textContent || 'N/A'}. Performance indicates ${stats[0]?.textContent > 50 ? 'high' : 'moderate'} usage patterns.`;
        }
        return 'Search for a vehicle first to get detailed analytics summary including trips, performance metrics, and usage patterns.';
    }
    
    if (lowerMessage.includes('performance') || lowerMessage.includes('efficiency')) {
        return 'Vehicle performance analysis includes: Trip frequency (indicates utilization), fuel efficiency (km/L ratio), average speed (driving patterns), and maintenance status. High-performing vehicles show consistent usage with optimal fuel consumption.';
    }
    
    if (lowerMessage.includes('maintenance') || lowerMessage.includes('service')) {
        return 'Maintenance insights: "Due" status requires immediate attention, "Up to Date" indicates good condition. Monitor fuel efficiency drops (may indicate engine issues), unusual speed patterns (potential mechanical problems), and trip frequency changes.';
    }
    
    if (lowerMessage.includes('location') || lowerMessage.includes('tracking')) {
        return 'Location tracking shows real-time position with GPS coordinates, last seen timestamp, and movement history. The map displays current location with accuracy radius. Historical data reveals usage patterns and route preferences.';
    }
    
    if (lowerMessage.includes('recommendation') || lowerMessage.includes('suggest')) {
        return 'Optimization recommendations: 1) Schedule maintenance for vehicles with "Due" status, 2) Investigate vehicles with low fuel efficiency, 3) Analyze high-mileage vehicles for replacement planning, 4) Monitor location patterns for route optimization.';
    }
    
    if (lowerMessage.includes('compare') || lowerMessage.includes('benchmark')) {
        return 'Vehicle benchmarking: Compare trip frequency (fleet average: 45 trips/month), fuel efficiency (target: >12 km/L), and utilization rates. High performers exceed benchmarks while underperformers may need attention.';
    }
    
    if (lowerMessage.includes('report') || lowerMessage.includes('export')) {
        return 'Generate detailed vehicle reports including: Performance analysis, maintenance schedule, fuel consumption trends, location history, and cost analysis. Reports can be exported as PDF with charts and recommendations. Say "generate report" for custom analysis.';
    }
    
    if (lowerMessage.includes('generate report') || lowerMessage.includes('custom report')) {
        const vehicleFound = document.querySelector('.vehicle-header');
        if (vehicleFound) {
            setTimeout(() => {
                addMessage('Generating comprehensive vehicle report... Including: 1) Performance Analysis, 2) Maintenance Recommendations, 3) Cost Breakdown, 4) Usage Patterns, 5) Predictive Insights. Report ready for download.', 'ai');
            }, 1500);
            return 'Creating detailed vehicle intelligence report with current data...';
        }
        return 'Please search for a vehicle first to generate a detailed report.';
    }
    
    if (lowerMessage.includes('alert') || lowerMessage.includes('warning')) {
        return 'Smart alerts available for: Maintenance due dates, unusual fuel consumption, location deviations, extended idle times, and performance anomalies. Set up proactive monitoring for fleet management.';
    }
    
    if (lowerMessage.includes('cost') || lowerMessage.includes('expense')) {
        return 'Cost analysis includes: Fuel expenses, maintenance costs, depreciation, and operational efficiency. Track cost per kilometer, monthly expenses, and ROI metrics for informed decision-making.';
    }
    
    if (lowerMessage.includes('predict') || lowerMessage.includes('forecast')) {
        return 'Predictive analytics: Forecast maintenance needs based on usage patterns, predict fuel costs from consumption trends, estimate vehicle lifespan, and identify optimal replacement timing.';
    }
    
    if (lowerMessage.includes('search') || lowerMessage.includes('find')) {
        return 'Advanced search capabilities: Enter license plate or VIN for instant vehicle lookup. Search supports partial matches and suggests similar vehicles. Use filters for specific vehicle types or organizations. Try searching for common plates like "KCA", "KDA", or "KBZ".';
    }
    
    if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
        return 'I provide comprehensive vehicle intelligence: üöó Vehicle search & analysis, üìä Performance insights, üîß Maintenance alerts, üìç Location tracking, üí∞ Cost analysis, üîÆ Predictive maintenance, üìã Custom reports. Try: "summary", "performance", "maintenance", or "generate report".';
    }
    
    if (lowerMessage.includes('insight') || lowerMessage.includes('analysis')) {
        return 'Vehicle intelligence insights: Usage patterns reveal optimal deployment, fuel efficiency trends indicate maintenance needs, location data shows route preferences, and performance metrics guide fleet optimization decisions.';
    }
    
    return 'I provide comprehensive vehicle intelligence including performance analysis, predictive maintenance, cost optimization, location tracking, and detailed reporting. What specific vehicle insights do you need?';
}

if (aiAssistantBtn) {
    aiAssistantBtn.addEventListener('click', toggleAIChat);
}

if (aiChatClose) {
    aiChatClose.addEventListener('click', closeAIChat);
}

if (aiChatSend) {
    aiChatSend.addEventListener('click', sendAIMessage);
}

if (aiChatInput) {
    aiChatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendAIMessage();
        }
    });
}

document.addEventListener('click', function(e) {
    if (aiChatModal.classList.contains('show') && 
        !aiChatModal.contains(e.target) && 
        !aiAssistantBtn.contains(e.target)) {
        closeAIChat();
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && aiChatModal.classList.contains('show')) {
        closeAIChat();
    }
});
</script>

{% endblock %}