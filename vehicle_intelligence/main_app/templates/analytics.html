{% extends 'base.html' %}

{% block title %}Analytics Dashboard - Vehicle Intelligence System{% endblock %}

{% block page_title_text %}Analytics Dashboard{% endblock %}
{% block page_subtitle %}Real-time vehicle fleet analytics and insights{% endblock %}

{% block extra_css %}
<style>
    .analytics-container {
        max-width: 1400px;
        margin: 0 auto;
        transition: margin-right 0.3s ease;
    }

    .analytics-container.chat-open {
        margin-right: 380px;
    }

    .analytics-header {
        margin-bottom: 32px;
    }

    .analytics-title {
        font-size: 28px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 8px;
    }

    .analytics-subtitle {
        font-size: 16px;
        color: #6b7280;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
    }

    .metric-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 24px;
        transition: all 0.2s ease;
    }

    .metric-card:hover {
        box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        transform: translateY(-2px);
    }

    .metric-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 16px;
    }

    .metric-title {
        font-size: 14px;
        font-weight: 500;
        color: #6b7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .metric-icon {
        width: 40px;
        height: 40px;
        background: #f0fdf4;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #16a34a;
        font-size: 18px;
    }

    .metric-value {
        font-size: 32px;
        font-weight: 700;
        color: #111827;
        margin-bottom: 8px;
        line-height: 1;
    }

    .metric-unit {
        font-size: 14px;
        color: #6b7280;
        font-weight: 500;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 32px;
        margin-bottom: 40px;
    }

    .chart-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
    }

    .chart-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
    }

    .chart-title {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .chart-body {
        padding: 24px;
    }

    .data-table {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 32px;
    }

    .table-header {
        padding: 20px 24px;
        border-bottom: 1px solid #e5e7eb;
        background: #f9fafb;
    }

    .table-title {
        font-size: 18px;
        font-weight: 600;
        color: #111827;
        margin: 0;
    }

    .modern-table {
        width: 100%;
        border-collapse: collapse;
    }

    .modern-table th {
        background: #f9fafb;
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        font-size: 14px;
        color: #6b7280;
        border-bottom: 1px solid #e5e7eb;
    }

    .modern-table td {
        padding: 16px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 14px;
        color: #111827;
    }

    .modern-table tr:hover {
        background: #f9fafb;
    }

    .badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        line-height: 1;
    }

    .badge-success {
        background: #dcfce7;
        color: #16a34a;
    }

    .badge-info {
        background: #dbeafe;
        color: #2563eb;
    }

    .loading {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 60px;
        color: #6b7280;
    }

    .no-data {
        text-align: center;
        padding: 60px 20px;
        color: #6b7280;
    }

    @media (max-width: 1024px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
        
        .metrics-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .analytics-container.chat-open {
            margin-right: 0;
        }
        
        .ai-chat-modal {
            width: calc(100vw - 40px);
            height: 400px;
            right: 20px;
            bottom: 90px;
            top: auto;
        }
    }

    @media (max-width: 768px) {
        .metrics-grid {
            grid-template-columns: 1fr;
        }
        
        .modern-table {
            font-size: 12px;
        }
        
        .ai-assistant-float {
            width: 56px;
            height: 56px;
            bottom: 20px;
            right: 20px;
        }
        
        .ai-assistant-float i {
            font-size: 24px;
        }
        
        .ai-tooltip {
            display: none;
        }
        
        .ai-chat-modal {
            width: calc(100vw - 20px);
            height: 350px;
            right: 10px;
            bottom: 80px;
        }
    }

    /* AI Assistant Styles */
    .ai-assistant-float {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 64px;
        height: 64px;
        background: linear-gradient(135deg, #16a34a, #15803d);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 8px 24px rgba(22, 163, 74, 0.3);
        transition: all 0.3s ease;
        z-index: 1000;
        border: 3px solid white;
    }

    .ai-assistant-float:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 32px rgba(22, 163, 74, 0.4);
        background: linear-gradient(135deg, #15803d, #166534);
    }

    .ai-assistant-float i {
        font-size: 28px;
        color: white;
        animation: pulse 2s infinite;
    }

    .ai-tooltip {
        position: absolute;
        right: 80px;
        top: 50%;
        transform: translateY(-50%);
        background: #111827;
        color: white;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        pointer-events: none;
    }

    .ai-tooltip::after {
        content: '';
        position: absolute;
        left: 100%;
        top: 50%;
        transform: translateY(-50%);
        border: 6px solid transparent;
        border-left-color: #111827;
    }

    .ai-assistant-float:hover .ai-tooltip {
        opacity: 1;
        visibility: visible;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    .ai-chat-modal {
        position: fixed;
        top: 0;
        right: 0;
        width: 380px;
        height: 100vh;
        background: white;
        border-left: 1px solid #e5e7eb;
        box-shadow: -4px 0 20px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        display: none;
        flex-direction: column;
        overflow: hidden;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    }

    .ai-chat-modal.show {
        display: flex;
        transform: translateX(0);
    }

    .ai-chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .ai-chat-header {
        padding: 16px 20px;
        background: linear-gradient(135deg, #16a34a, #15803d);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e5e7eb;
    }

    .ai-chat-title {
        display: flex;
        align-items: center;
        gap: 10px;
        font-weight: 600;
        font-size: 16px;
    }

    .ai-chat-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        transition: background 0.2s ease;
    }

    .ai-chat-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .ai-chat-messages {
        flex: 1;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
        background: #f9fafb;
    }

    .ai-message, .user-message {
        display: flex;
        gap: 12px;
        align-items: flex-start;
    }

    .user-message {
        flex-direction: row-reverse;
    }

    .ai-avatar, .user-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        flex-shrink: 0;
    }

    .ai-avatar {
        background: linear-gradient(135deg, #16a34a, #15803d);
        color: white;
    }

    .user-avatar {
        background: #3b82f6;
        color: white;
    }

    .ai-message-content, .user-message-content {
        background: white;
        padding: 12px 16px;
        border-radius: 12px;
        max-width: 280px;
        font-size: 14px;
        line-height: 1.5;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        color: #111827;
        font-weight: 500;
    }

    .user-message-content {
        background: #3b82f6;
        color: white;
    }

    .ai-chat-input {
        padding: 16px 20px;
        border-top: 1px solid #e5e7eb;
        display: flex;
        gap: 12px;
        align-items: center;
        background: white;
    }

    .ai-chat-input input {
        flex: 1;
        padding: 12px 16px;
        border: 1px solid #e5e7eb;
        border-radius: 24px;
        font-size: 14px;
        outline: none;
    }

    .ai-chat-input input:focus {
        border-color: #16a34a;
        box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }

    .ai-chat-input button {
        width: 40px;
        height: 40px;
        background: #16a34a;
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s ease;
    }

    .ai-chat-input button:hover {
        background: #15803d;
    }

    .ai-chat-input button:disabled {
        background: #9ca3af;
        cursor: not-allowed;
    }
    
    /* Typing indicator styles */
    .typing-dots {
        display: flex;
        gap: 4px;
        align-items: center;
    }
    
    .typing-dots span {
        width: 6px;
        height: 6px;
        background: #6b7280;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
        40% { transform: scale(1); opacity: 1; }
    }
</style>
{% endblock %}

{% block content %}
<div class="analytics-container">
    <!-- Analytics Header -->
    <div class="analytics-header">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <div>
                <h1 class="analytics-title">Fleet Analytics</h1>
                <p class="analytics-subtitle">Comprehensive insights into your vehicle fleet performance and utilization</p>
            </div>
            <div style="display: flex; gap: 16px; align-items: center;">
                <button onclick="downloadAnalyticsReport()" style="background: #16a34a; color: white; border: none; padding: 10px 20px; border-radius: 6px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-download"></i>
                    Download PDF Report
                </button>
                <button onclick="resetFilters()" style="background: #6b7280; color: white; border: none; padding: 10px 16px; border-radius: 6px; font-weight: 500; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-refresh"></i>
                    Reset Filters
                </button>
                <div style="display: flex; gap: 12px;">
                    {% if is_super_admin and available_organizations %}
                    <div style="min-width: 200px;">
                        <label for="organizationFilter" style="display: block; font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 4px;">Organization</label>
                        <select id="organizationFilter" onchange="applyFilters()" style="width: 100%; padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; background: white;">
                            <option value="">All Organizations</option>
                            {% for org in available_organizations %}
                            <option value="{{ org.id }}" {% if selected_organization and selected_organization.id == org.id %}selected{% endif %}>
                                {{ org.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}
                    <div style="min-width: 150px;">
                        <label for="brandFilter" style="display: block; font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 4px;">Vehicle Brand</label>
                        <select id="brandFilter" onchange="applyFilters()" style="width: 100%; padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; background: white;">
                            <option value="">All Brands</option>
                            {% for brand in available_brands %}
                            <option value="{{ brand }}" {% if selected_brand == brand %}selected{% endif %}>
                                {{ brand }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div style="min-width: 150px;">
                        <label for="typeFilter" style="display: block; font-size: 12px; font-weight: 500; color: #6b7280; margin-bottom: 4px;">Vehicle Type</label>
                        <select id="typeFilter" onchange="applyFilters()" style="width: 100%; padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px; background: white;">
                            <option value="">All Types</option>
                            {% for type in available_types %}
                            <option value="{{ type }}" {% if selected_type == type %}selected{% endif %}>
                                {{ type }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Key Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Total Vehicles</div>
                <div class="metric-icon"><i class="fas fa-car"></i></div>
            </div>
            <div class="metric-value">{{ fleet_summary.total_vehicles }}</div>
            <div class="metric-unit">Active Fleet</div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Active Vehicles</div>
                <div class="metric-icon"><i class="fas fa-car-side"></i></div>
            </div>
            <div class="metric-value">{{ fleet_summary.active_vehicles }}</div>
            <div class="metric-unit">In Use</div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Utilization Rate</div>
                <div class="metric-icon"><i class="fas fa-chart-line"></i></div>
            </div>
            <div class="metric-value">{{ fleet_summary.utilization_rate|floatformat:1 }}%</div>
            <div class="metric-unit">Fleet Usage</div>
        </div>

        <div class="metric-card">
            <div class="metric-header">
                <div class="metric-title">Avg Parking Duration</div>
                <div class="metric-icon"><i class="fas fa-clock"></i></div>
            </div>
            <div class="metric-value">{{ fleet_summary.avg_parking_duration|floatformat:0 }}</div>
            <div class="metric-unit">Minutes</div>
        </div>


    </div>

    <!-- Charts -->
    <div class="charts-grid">
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Parking Duration Analysis</h3>
            </div>
            <div class="chart-body">
                {% if parking_duration_chart %}
                    <div id="parkingDurationChart"></div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-clock" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No parking duration data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Hourly Vehicle Entries</h3>
            </div>
            <div class="chart-body">
                {% if hourly_entries_chart %}
                    <div id="hourlyEntriesChart"></div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-clock" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No hourly entry data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Vehicles per Organization</h3>
            </div>
            <div class="chart-body">
                {% if vehicles_per_site_chart %}
                    <div id="vehiclesPerSiteChart"></div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-building" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No vehicle distribution data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Revenue per Organization</h3>
            </div>
            <div class="chart-body">
                {% if revenue_per_site_chart %}
                    <div id="revenuePerSiteChart"></div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-money-bill-wave" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No revenue data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Vehicle Visit Patterns</h3>
            </div>
            <div class="chart-body">
                {% if visit_patterns_chart %}
                    <div id="visitPatternsChart"></div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-chart-bar" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No visit pattern data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <h3 class="chart-title">Average Stay by Vehicle Type</h3>
            </div>
            <div class="chart-body">
                {% if avg_stay_by_type_chart %}
                    <div id="avgStayByTypeChart"></div>
                {% else %}
                    <div class="no-data">
                        <i class="fas fa-clock" style="font-size: 48px; margin-bottom: 16px;"></i>
                        <p>No stay duration data available</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Driver Performance Table -->
    {% if driver_performance %}
    <div class="data-table">
        <div class="table-header">
            <h3 class="table-title">Driver Performance (Last 30 Days)</h3>
        </div>
        <div style="overflow-x: auto;">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>Driver</th>
                        <th>Total Trips</th>
                        <th>Distance (KM)</th>
                        <th>Avg Speed (KM/H)</th>
                        <th>Fuel Efficiency</th>
                        <th>Performance</th>
                    </tr>
                </thead>
                <tbody>
                    {% for driver in driver_performance %}
                    <tr>
                        <td>{{ driver.driver_name }}</td>
                        <td>{{ driver.total_trips }}</td>
                        <td>{{ driver.total_distance|floatformat:1 }}</td>
                        <td>{{ driver.avg_speed|floatformat:1 }}</td>
                        <td>{{ driver.fuel_efficiency|floatformat:2 }} KM/L</td>
                        <td>
                            {% if driver.fuel_efficiency > 10 %}
                                <span class="badge badge-success">Excellent</span>
                            {% else %}
                                <span class="badge badge-info">Good</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Route Analysis Table -->
    {% if route_analysis %}
    <div class="data-table">
        <div class="table-header">
            <h3 class="table-title">Most Frequent Routes</h3>
        </div>
        <div style="overflow-x: auto;">
            <table class="modern-table">
                <thead>
                    <tr>
                        <th>Route</th>
                        <th>Frequency</th>
                        <th>Avg Distance (KM)</th>
                        <th>Avg Duration (Min)</th>
                        <th>Total Fuel (L)</th>
                    </tr>
                </thead>
                <tbody>
                    {% for route in route_analysis %}
                    <tr>
                        <td>{{ route.route }}</td>
                        <td>{{ route.frequency }}</td>
                        <td>{{ route.avg_distance|floatformat:1 }}</td>
                        <td>{{ route.avg_duration|floatformat:0 }}</td>
                        <td>{{ route.total_fuel|floatformat:1 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

<!-- AI Assistant Floating Button -->
<div class="ai-assistant-float" id="aiAssistantBtn">
    <div class="ai-tooltip">AI Assistant - Get instant help!</div>
    <i class="fas fa-robot"></i>
</div>

<!-- AI Assistant Chat Modal -->
<div id="aiChatModal" class="ai-chat-modal">
    <div class="ai-chat-container">
        <div class="ai-chat-header">
            <div class="ai-chat-title">
                <i class="fas fa-robot"></i>
                <span>AI Assistant</span>
            </div>
            <button class="ai-chat-close" id="aiChatClose">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="ai-chat-messages" id="aiChatMessages">
            <div class="ai-message">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
                <div class="ai-message-content">
                    Hello! I'm your advanced AI analytics assistant. I can provide deep insights, trend analysis, performance summaries, optimization recommendations, predictive forecasting, and generate comprehensive reports. Ask me about patterns, KPIs, or say "summary" for an overview!
                </div>
            </div>
        </div>
        <div class="ai-chat-input">
            <input type="text" id="aiChatInput" placeholder="Ask me about your analytics data..." maxlength="500">
            <button id="aiChatSend">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    // Render charts
    {% if parking_duration_chart %}
    var parkingDurationData = {{ parking_duration_chart|safe }};
    Plotly.newPlot('parkingDurationChart', parkingDurationData.data, parkingDurationData.layout, {responsive: true});
    {% endif %}
    
    {% if hourly_entries_chart %}
    var hourlyEntriesData = {{ hourly_entries_chart|safe }};
    Plotly.newPlot('hourlyEntriesChart', hourlyEntriesData.data, hourlyEntriesData.layout, {responsive: true});
    {% endif %}
    
    {% if vehicles_per_site_chart %}
    var vehiclesPerSiteData = {{ vehicles_per_site_chart|safe }};
    Plotly.newPlot('vehiclesPerSiteChart', vehiclesPerSiteData.data, vehiclesPerSiteData.layout, {responsive: true});
    {% endif %}
    
    {% if revenue_per_site_chart %}
    var revenuePerSiteData = {{ revenue_per_site_chart|safe }};
    Plotly.newPlot('revenuePerSiteChart', revenuePerSiteData.data, revenuePerSiteData.layout, {responsive: true});
    {% endif %}
    
    {% if visit_patterns_chart %}
    var visitPatternsData = {{ visit_patterns_chart|safe }};
    Plotly.newPlot('visitPatternsChart', visitPatternsData.data, visitPatternsData.layout, {responsive: true});
    {% endif %}
    
    {% if avg_stay_by_type_chart %}
    var avgStayByTypeData = {{ avg_stay_by_type_chart|safe }};
    Plotly.newPlot('avgStayByTypeChart', avgStayByTypeData.data, avgStayByTypeData.layout, {responsive: true});
    {% endif %}
    
    // Reset all filters function
    function resetFilters() {
        // Navigate to analytics page without any parameters
        window.location.href = '/analytics/';
    }
    
    // Apply all filters function
    function applyFilters() {
        const url = new URL(window.location.href);
        
        // Get filter values
        const orgSelect = document.getElementById('organizationFilter');
        const brandSelect = document.getElementById('brandFilter');
        const typeSelect = document.getElementById('typeFilter');
        
        // Apply organization filter
        if (orgSelect && orgSelect.value) {
            url.searchParams.set('organization', orgSelect.value);
        } else {
            url.searchParams.delete('organization');
        }
        
        // Apply brand filter
        if (brandSelect.value) {
            url.searchParams.set('vehicle_brand', brandSelect.value);
        } else {
            url.searchParams.delete('vehicle_brand');
        }
        
        // Apply type filter
        if (typeSelect.value) {
            url.searchParams.set('vehicle_type', typeSelect.value);
        } else {
            url.searchParams.delete('vehicle_type');
        }
        
        // Reload page with new filters
        window.location.href = url.toString();
    }
    
    // Download analytics report function
    function downloadAnalyticsReport() {
        const url = new URL('/export-analytics-report/', window.location.origin);
        
        // Add all current filters
        const orgSelect = document.getElementById('organizationFilter');
        const brandSelect = document.getElementById('brandFilter');
        const typeSelect = document.getElementById('typeFilter');
        
        if (orgSelect && orgSelect.value) {
            url.searchParams.set('organization', orgSelect.value);
        }
        if (brandSelect && brandSelect.value) {
            url.searchParams.set('vehicle_brand', brandSelect.value);
        }
        if (typeSelect && typeSelect.value) {
            url.searchParams.set('vehicle_type', typeSelect.value);
        }
        
        // Open download in new tab
        window.open(url.toString(), '_blank');
    }

    // AI Assistant functionality
    const aiAssistantBtn = document.getElementById('aiAssistantBtn');
    const aiChatModal = document.getElementById('aiChatModal');
    const aiChatClose = document.getElementById('aiChatClose');
    const aiChatInput = document.getElementById('aiChatInput');
    const aiChatSend = document.getElementById('aiChatSend');
    const aiChatMessages = document.getElementById('aiChatMessages');
    
    function toggleAIChat() {
        aiChatModal.classList.toggle('show');
        document.querySelector('.analytics-container').classList.toggle('chat-open');
        if (aiChatModal.classList.contains('show')) {
            aiChatInput.focus();
        }
    }
    
    function closeAIChat() {
        aiChatModal.classList.remove('show');
        document.querySelector('.analytics-container').classList.remove('chat-open');
    }
    
    function sendAIMessage() {
        const message = aiChatInput.value.trim();
        if (!message) return;
        
        addMessage(message, 'user');
        aiChatInput.value = '';
        aiChatSend.disabled = true;
        
        // Show typing indicator
        addTypingIndicator();
        
        // Get current filters for context
        const filters = getCurrentFilters();
        
        // Send to AI API
        fetch('/api/ai-chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                message: message,
                page_type: 'analytics',
                filters: filters
            })
        })
        .then(response => response.json())
        .then(data => {
            removeTypingIndicator();
            if (data.success) {
                addMessage(data.response, 'ai');
                if (data.source === 'openai') {
                    addMessage('üí° Powered by OpenAI GPT', 'ai', true);
                }
            } else {
                addMessage('Sorry, I encountered an error. Please try again.', 'ai');
            }
        })
        .catch(error => {
            removeTypingIndicator();
            console.error('AI Chat Error:', error);
            // Fallback to local response
            const response = getAIResponse(message);
            addMessage(response, 'ai');
        })
        .finally(() => {
            aiChatSend.disabled = false;
        });
    }
    
    function getCurrentFilters() {
        const filters = {};
        const orgSelect = document.getElementById('organizationFilter');
        const brandSelect = document.getElementById('brandFilter');
        const typeSelect = document.getElementById('typeFilter');
        
        if (orgSelect && orgSelect.value) filters.organization = orgSelect.value;
        if (brandSelect && brandSelect.value) filters.vehicle_brand = brandSelect.value;
        if (typeSelect && typeSelect.value) filters.vehicle_type = typeSelect.value;
        
        return filters;
    }
    
    function addTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'ai-message typing-indicator';
        typingDiv.innerHTML = `
            <div class="ai-avatar"><i class="fas fa-robot"></i></div>
            <div class="ai-message-content">
                <div class="typing-dots">
                    <span></span><span></span><span></span>
                </div>
            </div>
        `;
        aiChatMessages.appendChild(typingDiv);
        aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
    }
    
    function removeTypingIndicator() {
        const typing = document.querySelector('.typing-indicator');
        if (typing) typing.remove();
    }
    
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
               document.querySelector('meta[name="csrf-token"]')?.content || '';
    }
    
    function addMessage(content, type, isSmall = false) {
        const messageDiv = document.createElement('div');
        messageDiv.className = type === 'user' ? 'user-message' : 'ai-message';
        
        const avatar = document.createElement('div');
        avatar.className = type === 'user' ? 'user-avatar' : 'ai-avatar';
        avatar.innerHTML = type === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
        
        const messageContent = document.createElement('div');
        messageContent.className = type === 'user' ? 'user-message-content' : 'ai-message-content';
        if (isSmall) messageContent.style.fontSize = '12px';
        messageContent.textContent = content;
        
        messageDiv.appendChild(avatar);
        messageDiv.appendChild(messageContent);
        
        aiChatMessages.appendChild(messageDiv);
        aiChatMessages.scrollTop = aiChatMessages.scrollHeight;
    }
    
    function getAIResponse(message) {
        const lowerMessage = message.toLowerCase();
        
        // Advanced analytics insights
        if (lowerMessage.includes('summary') || lowerMessage.includes('overview')) {
            return `Based on current data: You have ${document.querySelector('.metric-value').textContent} total vehicles with ${document.querySelectorAll('.metric-value')[1].textContent} active. Fleet utilization is at ${document.querySelectorAll('.metric-value')[2].textContent}. Key insights: Peak usage hours show optimal fleet deployment, and revenue trends indicate strong performance across organizations.`;
        }
        
        if (lowerMessage.includes('recommendation') || lowerMessage.includes('suggest')) {
            return 'Based on your analytics: 1) Consider redistributing vehicles during low-utilization periods, 2) Focus on high-revenue generating routes, 3) Implement predictive maintenance for vehicles with high usage, 4) Optimize parking duration to increase turnover rates.';
        }
        
        if (lowerMessage.includes('trend') || lowerMessage.includes('pattern')) {
            return 'Key patterns identified: Hourly entries peak during business hours (9-11 AM, 2-4 PM), parking duration varies by organization type, and revenue correlates strongly with vehicle visit frequency. Weekend patterns show 30% lower activity.';
        }
        
        if (lowerMessage.includes('performance') || lowerMessage.includes('kpi')) {
            return 'Performance metrics show: Average parking duration indicates efficient space utilization, vehicle distribution across organizations is balanced, and revenue per organization demonstrates healthy business growth. Driver performance data reveals optimization opportunities.';
        }
        
        if (lowerMessage.includes('report') || lowerMessage.includes('export')) {
            return 'I can help generate detailed reports including: Executive Summary with KPIs, Driver Performance Analysis, Route Optimization Report, Revenue Analysis by Organization, and Predictive Maintenance Schedule. Click "Download PDF Report" for comprehensive analytics. Say "generate report" for custom analysis.';
        }
        
        if (lowerMessage.includes('generate report') || lowerMessage.includes('custom report')) {
            setTimeout(() => {
                addMessage('Generating custom analytics report with current filters... This includes: 1) Executive Summary, 2) Performance Metrics, 3) Trend Analysis, 4) Recommendations, 5) Predictive Insights. Report will be available for download shortly.', 'ai');
            }, 1500);
            return 'Initiating custom report generation based on your current analytics view...';
        }
        
        if (lowerMessage.includes('chart') || lowerMessage.includes('graph')) {
            return 'Chart analysis: Parking Duration shows usage patterns, Hourly Entries reveal peak times, Vehicle Distribution indicates market penetration, Revenue charts show financial performance, and Visit Patterns help optimize operations.';
        }
        
        if (lowerMessage.includes('filter') || lowerMessage.includes('organization')) {
            return 'Smart filtering available: Filter by organization to analyze specific clients, by vehicle brand for manufacturer insights, or by vehicle type for category analysis. Combine filters for granular insights and targeted reporting.';
        }
        
        if (lowerMessage.includes('optimization') || lowerMessage.includes('improve')) {
            return 'Optimization opportunities: 1) Redistribute vehicles based on demand patterns, 2) Adjust pricing for peak hours, 3) Implement dynamic routing, 4) Schedule maintenance during low-usage periods, 5) Expand fleet in high-demand areas.';
        }
        
        if (lowerMessage.includes('cost') || lowerMessage.includes('revenue')) {
            return 'Financial insights: Revenue per organization shows market value, cost analysis reveals operational efficiency, and ROI metrics indicate profitable segments. Consider dynamic pricing and cost optimization strategies.';
        }
        
        if (lowerMessage.includes('predict') || lowerMessage.includes('forecast')) {
            return 'Predictive insights: Based on current trends, expect 15-20% growth in vehicle usage, peak demand during Q2-Q3, and maintenance requirements increasing with fleet age. Plan capacity expansion accordingly.';
        }
        
        if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
            return 'I provide advanced analytics intelligence: üìä Performance summaries, üìà Trend analysis, üéØ Optimization recommendations, üîÆ Predictive forecasting, üìã Custom reports, üîç Data interpretation, üì± Smart insights. Try: "summary", "trends", "recommendations", or "generate report".';
        }
        
        if (lowerMessage.includes('insight') || lowerMessage.includes('analysis')) {
            return 'Key insights from your data: Peak utilization occurs during business hours, revenue patterns show seasonal variations, vehicle distribution indicates market opportunities, and maintenance schedules can be optimized. What specific insight interests you?';
        }
        
        return 'I provide advanced analytics insights including performance summaries, trend analysis, optimization recommendations, predictive forecasting, and detailed reporting. What specific analysis would you like me to perform?';
    }
    
    // AI Assistant functionality
    const aiAssistantBtn = document.getElementById('aiAssistantBtn');
    const aiChatModal = document.getElementById('aiChatModal');
    const aiChatClose = document.getElementById('aiChatClose');
    const aiChatInput = document.getElementById('aiChatInput');
    const aiChatSend = document.getElementById('aiChatSend');
    const aiChatMessages = document.getElementById('aiChatMessages');
    
    if (aiAssistantBtn) {
        aiAssistantBtn.addEventListener('click', toggleAIChat);
    }
    
    if (aiChatClose) {
        aiChatClose.addEventListener('click', closeAIChat);
    }
    
    if (aiChatSend) {
        aiChatSend.addEventListener('click', sendAIMessage);
    }
    
    if (aiChatInput) {
        aiChatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendAIMessage();
            }
        });
    }
    
    document.addEventListener('click', function(e) {
        if (aiChatModal && aiChatModal.classList.contains('show') && 
            !aiChatModal.contains(e.target) && 
            !aiAssistantBtn.contains(e.target)) {
            closeAIChat();
        }
    });
    
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && aiChatModal && aiChatModal.classList.contains('show')) {
            closeAIChat();
        }
    });
</script>
{% endblock %}