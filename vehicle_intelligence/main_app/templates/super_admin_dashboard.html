{% extends 'base.html' %}

{% block title %}Super Admin Dashboard{% endblock %}

{% block extra_css %}
<style>
.super-admin-dashboard {
    max-width: 1400px;
    margin: 0 auto;
}

.dashboard-header {
    background: linear-gradient(135deg, #f59e0b, #d97706);
    color: white;
    padding: 30px;
    border-radius: 16px;
    margin-bottom: 30px;
}

.dashboard-header h1 {
    margin: 0 0 10px 0;
    display: flex;
    align-items: center;
    gap: 15px;
}

.dashboard-header p {
    margin: 0;
    opacity: 0.9;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    border: 1px solid #e2e8f0;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.stat-icon.primary { background: linear-gradient(135deg, #3b82f6, #2563eb); }
.stat-icon.success { background: linear-gradient(135deg, #10b981, #059669); }
.stat-icon.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
.stat-icon.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
.stat-icon.info { background: linear-gradient(135deg, #64748b, #475569); }
.stat-icon.purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

.stat-info h3 {
    margin: 0 0 5px 0;
    font-size: 32px;
    font-weight: 700;
    color: #1e293b;
    line-height: 1;
}

.stat-info p {
    margin: 0;
    color: #64748b;
    font-size: 14px;
}

.admin-tabs {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.tab-header {
    display: flex;
    background: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
    padding: 0 20px;
    flex-wrap: wrap;
}

.tab-btn {
    padding: 18px 24px;
    background: none;
    border: none;
    font-size: 14px;
    font-weight: 600;
    color: #64748b;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 10px;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    white-space: nowrap;
}

.tab-btn:hover {
    color: #3b82f6;
    background: rgba(59, 130, 246, 0.05);
}

.tab-btn.active {
    color: #3b82f6;
    border-bottom-color: #3b82f6;
    background: white;
}

.tab-content {
    display: none;
    padding: 30px;
}

.tab-content.active {
    display: block;
}

.tab-header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e2e8f0;
    flex-wrap: wrap;
    gap: 15px;
}

.filter-controls {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.form-select, .form-control {
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
    min-width: 150px;
    background: white;
}

.form-select:focus, .form-control:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    font-size: 14px;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(37, 99, 235, 0.2);
}

.btn-secondary {
    background: #64748b;
    color: white;
}

.btn-secondary:hover {
    background: #475569;
}

.btn-success {
    background: #10b981;
    color: white;
}

.btn-success:hover {
    background: #059669;
}

.btn-warning {
    background: #f59e0b;
    color: white;
}

.btn-warning:hover {
    background: #d97706;
}

.btn-danger {
    background: #ef4444;
    color: white;
}

.btn-danger:hover {
    background: #dc2626;
}

.btn-sm {
    padding: 6px 12px;
    font-size: 12px;
}

.table-container {
    overflow-x: auto;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
    margin-top: 20px;
}

.data-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 800px;
}

.data-table th {
    background: #f8fafc;
    padding: 15px;
    text-align: left;
    font-weight: 600;
    color: #475569;
    border-bottom: 2px solid #e2e8f0;
    white-space: nowrap;
}

.data-table td {
    padding: 15px;
    border-bottom: 1px solid #e2e8f0;
    vertical-align: middle;
}

.data-table tr:hover {
    background: #f8fafc;
}

.status-badge {
    padding: 4px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    display: inline-block;
}

.status-badge.active {
    background: #d1fae5;
    color: #065f46;
}

.status-badge.inactive {
    background: #fee2e2;
    color: #991b1b;
}

.status-badge.super-admin {
    background: #fef3c7;
    color: #92400e;
}

.status-badge.org-admin {
    background: #dbeafe;
    color: #1e40af;
}

.actions {
    display: flex;
    gap: 8px;
    flex-wrap: nowrap;
}

.btn-icon {
    width: 36px;
    height: 36px;
    border-radius: 6px;
    border: 1px solid #d1d5db;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    color: #64748b;
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background: #f3f4f6;
    color: #374151;
}

.btn-icon.btn-edit:hover {
    background: #dbeafe;
    color: #2563eb;
    border-color: #93c5fd;
}

.btn-icon.btn-delete:hover {
    background: #fee2e2;
    color: #ef4444;
    border-color: #fca5a5;
}

.btn-icon.btn-reset:hover {
    background: #f0fdf4;
    color: #10b981;
    border-color: #86efac;
}

.btn-icon.btn-admin:hover {
    background: #f3e8ff;
    color: #7c3aed;
    border-color: #c4b5fd;
}

.activity-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-height: 600px;
    overflow-y: auto;
    padding-right: 10px;
}

.activity-item {
    display: flex;
    gap: 15px;
    padding: 15px;
    background: #f8fafc;
    border-radius: 8px;
    border-left: 4px solid #3b82f6;
    transition: background 0.2s ease;
}

.activity-item:hover {
    background: #f1f5f9;
}

.activity-icon {
    font-size: 20px;
    min-width: 40px;
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding-top: 2px;
}

.activity-content {
    flex: 1;
    min-width: 0;
}

.activity-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 8px;
    flex-wrap: wrap;
}

.badge {
    padding: 3px 8px;
    border-radius: 4px;
    font-size: 11px;
    font-weight: 600;
    text-transform: uppercase;
}

.badge-login { background: #d1fae5; color: #065f46; }
.badge-logout { background: #fef3c7; color: #92400e; }
.badge-create { background: #dbeafe; color: #1e40af; }
.badge-update { background: #e0e7ff; color: #3730a3; }
.badge-delete { background: #fee2e2; color: #991b1b; }
.badge-module { background: #f3f4f6; color: #374151; }

.activity-time {
    margin-left: auto;
    color: #6b7280;
    font-size: 12px;
    white-space: nowrap;
}

.activity-description {
    margin: 0 0 8px 0;
    color: #374151;
    word-break: break-word;
}

.activity-meta {
    display: flex;
    gap: 15px;
    font-size: 12px;
    color: #6b7280;
    flex-wrap: wrap;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #6b7280;
}

.empty-state i {
    margin-bottom: 15px;
    opacity: 0.5;
    font-size: 48px;
}

.empty-state h3 {
    margin: 0 0 10px 0;
    font-size: 18px;
    font-weight: 600;
}

.empty-state p {
    margin: 0;
    color: #9ca3af;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 10000;
    align-items: center;
    justify-content: center;
    padding: 20px;
}

.modal.active {
    display: flex;
}

.modal-content {
    background: white;
    border-radius: 16px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
}

@keyframes modalSlideIn {
    from {
        opacity: 0;
        transform: translateY(-20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid #e2e8f0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h3 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 20px;
}

.close-modal {
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: #6b7280;
    padding: 0;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 50%;
    transition: all 0.2s ease;
}

.close-modal:hover {
    background: #f3f4f6;
    color: #374151;
}

.modal-body {
    padding: 24px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #374151;
}

.form-group .form-control, .form-group .form-select {
    width: 100%;
    padding: 10px 12px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
}

.form-group .form-control:focus, .form-group .form-select:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
}

.modal-footer {
    padding: 24px;
    border-top: 1px solid #e2e8f0;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
}

.pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    margin-top: 20px;
    padding-top: 20px;
    border-top: 1px solid #e2e8f0;
}

.pagination-btn {
    padding: 8px 16px;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
}

.pagination-btn:hover:not(:disabled) {
    background: #f3f4f6;
    border-color: #9ca3af;
}

.pagination-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.pagination-info {
    font-size: 14px;
    color: #6b7280;
}

.loading {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 40px;
    color: #6b7280;
}

.loading i {
    font-size: 24px;
    margin-right: 10px;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}

.alert-message {
    padding: 12px 16px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    display: none;
}

.alert-success {
    background: #f0fdf4;
    border-color: #bbf7d0;
    color: #166534;
    display: block;
}

.alert-error {
    background: #fef2f2;
    border-color: #fecaca;
    color: #dc2626;
    display: block;
}

.alert-info {
    background: #f0f9ff;
    border-color: #bae6fd;
    color: #0369a1;
    display: block;
}

.search-box {
    position: relative;
    min-width: 250px;
}

.search-box input {
    width: 100%;
    padding: 10px 12px 10px 40px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 14px;
}

.search-box i {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #9ca3af;
}

@media (max-width: 768px) {
    .stats-row {
        grid-template-columns: 1fr;
    }
    
    .tab-header {
        padding: 0;
    }
    
    .tab-btn {
        padding: 15px;
        flex: 1;
        min-width: 120px;
        justify-content: center;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .filter-controls {
        width: 100%;
    }
    
    .tab-header-actions {
        flex-direction: column;
        align-items: stretch;
    }
    
    .btn {
        width: 100%;
        justify-content: center;
    }
    
    .actions {
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .activity-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 5px;
    }
    
    .activity-time {
        margin-left: 0;
    }
}

.toggle-switch {
    position: relative;
    display: inline-block;
    width: 60px;
    height: 34px;
}

.toggle-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.toggle-slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: .4s;
    border-radius: 34px;
}

.toggle-slider:before {
    position: absolute;
    content: "";
    height: 26px;
    width: 26px;
    left: 4px;
    bottom: 4px;
    background-color: white;
    transition: .4s;
    border-radius: 50%;
}

input:checked + .toggle-slider {
    background-color: #3b82f6;
}

input:checked + .toggle-slider:before {
    transform: translateX(26px);
}

.password-display {
    background: #f8fafc;
    border: 1px solid #e2e8f0;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
    font-family: monospace;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.password-display code {
    color: #ef4444;
    font-weight: bold;
}

.password-display button {
    padding: 4px 8px;
    font-size: 12px;
}
</style>
{% endblock %}

{% block content %}
<div class="super-admin-dashboard">
    <!-- System Overview -->
    <div class="dashboard-header">
        <h1><i class="fas fa-crown"></i> Super Admin Dashboard</h1>
        <p>Complete System Administration & Management</p>
    </div>

    <!-- Quick Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon primary">
                <i class="fas fa-building"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_organizations }}</h3>
                <p>Total Organizations</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ active_organizations }}</h3>
                <p>Active Organizations</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon warning">
                <i class="fas fa-user-shield"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_system_users }}</h3>
                <p>System Users</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon danger">
                <i class="fas fa-user-crown"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_super_admins }}</h3>
                <p>Super Admins</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon info">
                <i class="fas fa-user-tie"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_org_admins }}</h3>
                <p>Organization Admins</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon purple">
                <i class="fas fa-exclamation-circle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ organizations_without_admins }}</h3>
                <p>Orgs Without Admins</p>
            </div>
        </div>
    </div>

    <!-- Quick Action Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-building text-primary"></i> Create Organization
            </h3>
            <form id="quickOrgForm">
                {% csrf_token %}
                <div class="form-group">
                    <input type="text" name="name" class="form-control" placeholder="Organization Name" required>
                </div>
                <div class="form-group">
                    <input type="email" name="email" class="form-control" placeholder="Email" required>
                </div>
                <button type="button" onclick="quickCreateOrganization()" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-plus"></i> Create Organization
                </button>
            </form>
        </div>

        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <h3 style="margin-top: 0; display: flex; align-items: center; gap: 10px;">
                <i class="fas fa-user-crown text-warning"></i> Create Super Admin
            </h3>
            <form id="quickSuperAdminForm">
                {% csrf_token %}
                <div class="form-row">
                    <div class="form-group">
                        <input type="text" name="username" class="form-control" placeholder="Username" required>
                    </div>
                    <div class="form-group">
                        <input type="email" name="email" class="form-control" placeholder="Email" required>
                    </div>
                </div>
                <button type="button" onclick="quickCreateSuperAdmin()" class="btn btn-warning" style="width: 100%;">
                    <i class="fas fa-user-plus"></i> Create Super Admin
                </button>
            </form>
        </div>
    </div>

    <!-- Main Administration Tabs -->
    <div class="admin-tabs">
        <div class="tab-header">
            <button class="tab-btn active" data-tab="organizations">
                <i class="fas fa-building"></i> Organizations
            </button>
            <button class="tab-btn" data-tab="users">
                <i class="fas fa-users"></i> System Users
            </button>
            <button class="tab-btn" data-tab="activities">
                <i class="fas fa-history"></i> Activity Log
            </button>
            <button class="tab-btn" data-tab="system">
                <i class="fas fa-cogs"></i> System Settings
            </button>
        </div>

        <!-- Organizations Tab -->
        <div class="tab-content active" id="organizations-tab">
            <div class="tab-header-actions">
                <div class="filter-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="orgSearch" placeholder="Search organizations..." class="form-control">
                    </div>
                    <select id="orgStatusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-primary" onclick="showAddOrganizationModal()">
                        <i class="fas fa-plus"></i> Add Organization
                    </button>
                    <button class="btn btn-success" onclick="showAddOrgAdminModal()">
                        <i class="fas fa-user-tie"></i> Add Organization Admin
                    </button>
                </div>
            </div>
            
            <div class="table-container">
                <div id="organizations-loading" class="loading">
                    <i class="fas fa-spinner"></i> Loading organizations...
                </div>
                <table class="data-table" id="organizations-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Organization Name</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Status</th>
                            <th>Created Date</th>
                            <th>Users</th>
                            <th>Admin</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="organizations-table-body">
                        <!-- Organizations will be loaded via AJAX -->
                    </tbody>
                </table>
                <div id="organizations-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-building"></i>
                    <h3>No organizations found</h3>
                    <p>Create your first organization to get started</p>
                </div>
            </div>
            
            <div class="pagination" id="organizations-pagination" style="display: none;">
                <button class="pagination-btn" onclick="loadOrganizations(1)" id="org-first-page">First</button>
                <button class="pagination-btn" onclick="loadOrganizations(currentOrgPage - 1)" id="org-prev-page">Previous</button>
                <span class="pagination-info" id="org-page-info">Page 1 of 1</span>
                <button class="pagination-btn" onclick="loadOrganizations(currentOrgPage + 1)" id="org-next-page">Next</button>
                <button class="pagination-btn" onclick="loadOrganizations(totalOrgPages)" id="org-last-page">Last</button>
            </div>
        </div>

        <!-- Users Tab -->
        <div class="tab-content" id="users-tab">
            <div class="tab-header-actions">
                <div class="filter-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="userSearch" placeholder="Search users..." class="form-control">
                    </div>
                    <select id="userRoleFilter" class="form-select">
                        <option value="">All Roles</option>
                        <option value="super_admin">Super Admin</option>
                        <option value="organization_admin">Organization Admin</option>
                    </select>
                    <select id="userStatusFilter" class="form-select">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="showAddUserModal()">
                    <i class="fas fa-user-plus"></i> Add User
                </button>
            </div>
            
            <div class="table-container">
                <div id="users-loading" class="loading">
                    <i class="fas fa-spinner"></i> Loading users...
                </div>
                <table class="data-table" id="users-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Role</th>
                            <th>Organization</th>
                            <th>Email</th>
                            <th>Last Active</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Users will be loaded via AJAX -->
                    </tbody>
                </table>
                <div id="users-empty" class="empty-state" style="display: none;">
                    <i class="fas fa-users"></i>
                    <h3>No users found</h3>
                    <p>Create your first user to get started</p>
                </div>
            </div>
            
            <div class="pagination" id="users-pagination" style="display: none;">
                <button class="pagination-btn" onclick="loadUsers(1)" id="user-first-page">First</button>
                <button class="pagination-btn" onclick="loadUsers(currentUserPage - 1)" id="user-prev-page">Previous</button>
                <span class="pagination-info" id="user-page-info">Page 1 of 1</span>
                <button class="pagination-btn" onclick="loadUsers(currentUserPage + 1)" id="user-next-page">Next</button>
                <button class="pagination-btn" onclick="loadUsers(totalUserPages)" id="user-last-page">Last</button>
            </div>
        </div>

        <!-- Activity Log Tab -->
        <div class="tab-content" id="activities-tab">
            <div class="tab-header-actions">
                <div class="filter-controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="activitySearch" placeholder="Search activities..." class="form-control">
                    </div>
                    <select id="actionFilter" class="form-select">
                        <option value="">All Actions</option>
                        <option value="login">Login</option>
                        <option value="logout">Logout</option>
                        <option value="create">Create</option>
                        <option value="update">Update</option>
                        <option value="delete">Delete</option>
                        <option value="view">View</option>
                        <option value="reset_password">Reset Password</option>
                    </select>
                    <select id="moduleFilter" class="form-select">
                        <option value="">All Modules</option>
                        <option value="authentication">Authentication</option>
                        <option value="user_management">User Management</option>
                        <option value="organizations">Organizations</option>
                        <option value="dashboard">Dashboard</option>
                    </select>
                    <input type="date" id="dateFrom" class="form-control" placeholder="From Date">
                    <input type="date" id="dateTo" class="form-control" placeholder="To Date">
                </div>
                <button class="btn btn-secondary" onclick="loadActivities(1)">
                    <i class="fas fa-filter"></i> Filter
                </button>
            </div>
            
            <div class="activity-list" id="activities-list">
                {% for activity in recent_system_activities %}
                <div class="activity-item">
                    <div class="activity-icon">
                        {% if activity.action == 'login' %}
                        <i class="fas fa-sign-in-alt text-success"></i>
                        {% elif activity.action == 'logout' %}
                        <i class="fas fa-sign-out-alt text-warning"></i>
                        {% elif activity.action == 'create' %}
                        <i class="fas fa-plus-circle text-primary"></i>
                        {% elif activity.action == 'update' %}
                        <i class="fas fa-edit text-info"></i>
                        {% elif activity.action == 'delete' %}
                        <i class="fas fa-trash-alt text-danger"></i>
                        {% elif activity.action == 'reset_password' %}
                        <i class="fas fa-key text-purple"></i>
                        {% else %}
                        <i class="fas fa-eye text-secondary"></i>
                        {% endif %}
                    </div>
                    <div class="activity-content">
                        <div class="activity-header">
                            <strong>{{ activity.user.username }}</strong>
                            <span class="badge badge-{{ activity.action }}">{{ activity.get_action_display }}</span>
                            <span class="badge badge-module">{{ activity.module|title }}</span>
                            <span class="activity-time">{{ activity.timestamp|timesince }} ago</span>
                        </div>
                        <p class="activity-description">{{ activity.description }}</p>
                        <div class="activity-meta">
                            {% if activity.organization %}
                            <span><i class="fas fa-building"></i> {{ activity.organization.name }}</span>
                            {% endif %}
                            {% if activity.ip_address %}
                            <span><i class="fas fa-globe"></i> {{ activity.ip_address }}</span>
                            {% endif %}
                            <span><i class="fas fa-user-agent"></i> {{ activity.user_agent|truncatechars:50 }}</span>
                        </div>
                    </div>
                </div>
                {% empty %}
                <div class="empty-state">
                    <i class="fas fa-history"></i>
                    <h3>No activity logs found</h3>
                    <p>Activities will appear here as users interact with the system</p>
                </div>
                {% endfor %}
            </div>
            
            <div class="pagination" id="activities-pagination" style="display: none;">
                <button class="pagination-btn" onclick="loadActivities(1)" id="activity-first-page">First</button>
                <button class="pagination-btn" onclick="loadActivities(currentActivityPage - 1)" id="activity-prev-page">Previous</button>
                <span class="pagination-info" id="activity-page-info">Page 1 of 1</span>
                <button class="pagination-btn" onclick="loadActivities(currentActivityPage + 1)" id="activity-next-page">Next</button>
                <button class="pagination-btn" onclick="loadActivities(totalActivityPages)" id="activity-last-page">Last</button>
            </div>
        </div>

        <!-- System Settings Tab -->
        <div class="tab-content" id="system-tab">
            <div class="settings-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                <div class="setting-card" style="background: #f8fafc; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3><i class="fas fa-shield-alt"></i> Security Settings</h3>
                    <div class="setting-item">
                        <label>Force Password Change</label>
                        <select class="form-select" id="passwordPolicy">
                            <option>On First Login</option>
                            <option>Every 30 Days</option>
                            <option>Every 90 Days</option>
                            <option>Never</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label>Session Timeout (minutes)</label>
                        <input type="number" class="form-control" id="sessionTimeout" value="60" min="5" max="1440">
                    </div>
                    <div class="setting-item">
                        <label>Enable Two-Factor Authentication</label>
                        <label class="toggle-switch">
                            <input type="checkbox">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="saveSecuritySettings()">Save Security Settings</button>
                </div>

                <div class="setting-card" style="background: #f8fafc; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3><i class="fas fa-bell"></i> Notifications</h3>
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" checked> New User Registration
                        </label>
                    </div>
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" checked> Organization Creation
                        </label>
                    </div>
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox"> Failed Login Attempts
                        </label>
                    </div>
                    <div class="setting-item">
                        <label style="display: flex; align-items: center; gap: 10px;">
                            <input type="checkbox" checked> System Errors
                        </label>
                    </div>
                    <button class="btn btn-primary" onclick="saveNotificationSettings()">Save Notification Settings</button>
                </div>

                <div class="setting-card" style="background: #f8fafc; padding: 24px; border-radius: 12px; border: 1px solid #e2e8f0;">
                    <h3><i class="fas fa-database"></i> System Information</h3>
                    <div class="setting-item">
                        <label>System Version</label>
                        <input type="text" class="form-control" value="v2.1.0" readonly>
                    </div>
                    <div class="setting-item">
                        <label>Total Organizations</label>
                        <input type="text" class="form-control" value="{{ total_organizations }}" readonly>
                    </div>
                    <div class="setting-item">
                        <label>Total Users</label>
                        <input type="text" class="form-control" value="{{ total_system_users }}" readonly>
                    </div>
                    <div class="setting-item">
                        <label>Last System Backup</label>
                        <input type="text" class="form-control" value="Yesterday, 2:00 AM" readonly>
                    </div>
                    <button class="btn btn-warning" onclick="backupSystem()">
                        <i class="fas fa-download"></i> Backup Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Organization Modal -->
<div id="addOrgModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-building"></i> Add New Organization</h3>
            <button class="close-modal" onclick="closeModal('addOrgModal')">&times;</button>
        </div>
        <form id="addOrgForm">
            <div class="modal-body">
                <div id="org-alert" class="alert-message" style="display: none;"></div>
                <div class="form-group">
                    <label>Organization Name *</label>
                    <input type="text" name="name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" name="phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea name="address" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="is_active" class="form-select">
                        <option value="true" selected>Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addOrgModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Organization</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit Organization Modal -->
<div id="editOrgModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit Organization</h3>
            <button class="close-modal" onclick="closeModal('editOrgModal')">&times;</button>
        </div>
        <form id="editOrgForm">
            <div class="modal-body">
                <div id="edit-org-alert" class="alert-message" style="display: none;"></div>
                <input type="hidden" name="id" id="edit-org-id">
                <div class="form-group">
                    <label>Organization Name *</label>
                    <input type="text" name="name" id="edit-org-name" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" name="email" id="edit-org-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" name="phone" id="edit-org-phone" class="form-control">
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea name="address" id="edit-org-address" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select name="is_active" id="edit-org-status" class="form-select">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editOrgModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Organization</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Organization Admin Modal -->
<div id="addOrgAdminModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-tie"></i> Add Organization Admin</h3>
            <button class="close-modal" onclick="closeModal('addOrgAdminModal')">&times;</button>
        </div>
        <form id="addOrgAdminForm">
            <div class="modal-body">
                <div id="org-admin-alert" class="alert-message" style="display: none;"></div>
                <div class="form-group">
                    <label>Select Organization *</label>
                    <select name="org_id" id="org-select" class="form-select" required>
                        <option value="">Select Organization</option>
                        <!-- Organizations will be populated via AJAX -->
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" name="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" name="first_name" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" name="last_name" class="form-control">
                    </div>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" name="phone" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addOrgAdminModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Admin</button>
            </div>
        </form>
    </div>
</div>

<!-- Add User Modal -->
<div id="addUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-user-plus"></i> Add New User</h3>
            <button class="close-modal" onclick="closeModal('addUserModal')">&times;</button>
        </div>
        <form id="addUserForm">
            <div class="modal-body">
                <div id="user-alert" class="alert-message" style="display: none;"></div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Username *</label>
                        <input type="text" name="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" name="first_name" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" name="last_name" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select name="role" class="form-select" required>
                            <option value="">Select Role</option>
                            <option value="super_admin">Super Administrator</option>
                            <option value="organization_admin">Organization Administrator</option>
                        </select>
                    </div>
                    <div class="form-group" id="org-select-group">
                        <label>Organization *</label>
                        <select name="organization" class="form-select">
                            <option value="">Select Organization</option>
                            <!-- Organizations will be loaded via AJAX -->
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="text" name="phone" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('addUserModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Create User</button>
            </div>
        </form>
    </div>
</div>

<!-- Edit User Modal -->
<div id="editUserModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-edit"></i> Edit User</h3>
            <button class="close-modal" onclick="closeModal('editUserModal')">&times;</button>
        </div>
        <form id="editUserForm">
            <div class="modal-body">
                <div id="edit-user-alert" class="alert-message" style="display: none;"></div>
                <input type="hidden" name="id" id="edit-user-id">
                <div class="form-row">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="edit-user-username" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label>Email *</label>
                        <input type="email" name="email" id="edit-user-email" class="form-control" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>First Name</label>
                        <input type="text" name="first_name" id="edit-user-first-name" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Last Name</label>
                        <input type="text" name="last_name" id="edit-user-last-name" class="form-control">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Role *</label>
                        <select name="role" id="edit-user-role" class="form-select" required>
                            <option value="super_admin">Super Administrator</option>
                            <option value="organization_admin">Organization Administrator</option>
                        </select>
                    </div>
                    <div class="form-group" id="edit-org-select-group">
                        <label>Organization *</label>
                        <select name="organization" id="edit-user-organization" class="form-select">
                            <!-- Organizations will be loaded via AJAX -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="text" name="phone" id="edit-user-phone" class="form-control">
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select name="is_active" id="edit-user-status" class="form-select">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
                <button type="submit" class="btn btn-primary">Update User</button>
            </div>
        </form>
    </div>
</div>

<!-- Confirm Modal -->
<div id="confirmModal" class="modal">
    <div class="modal-content" style="max-width: 400px;">
        <div class="modal-header">
            <h3><i class="fas fa-exclamation-triangle text-warning"></i> Confirm Action</h3>
            <button class="close-modal" onclick="closeModal('confirmModal')">&times;</button>
        </div>
        <div class="modal-body">
            <p id="confirm-message">Are you sure you want to perform this action?</p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirm-action-btn">Confirm</button>
        </div>
    </div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3><i class="fas fa-key text-success"></i> Temporary Password</h3>
            <button class="close-modal" onclick="closeModal('passwordModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div id="password-alert" class="alert-info">
                <i class="fas fa-info-circle"></i> Please save this password. It will not be shown again.
            </div>
            <div class="password-display">
                <code id="temp-password-display"></code>
                <button type="button" class="btn btn-sm btn-outline-primary" onclick="copyPassword()">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <p class="text-muted" style="font-size: 12px;">
                <i class="fas fa-exclamation-circle"></i> User must change this password on first login.
            </p>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-primary" onclick="closeModal('passwordModal')">Close</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentOrgPage = 1;
let totalOrgPages = 1;
let currentUserPage = 1;
let totalUserPages = 1;
let currentActivityPage = 1;
let totalActivityPages = 1;
let pendingAction = null;
let pendingActionData = null;

// CSRF Token helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tabId = btn.dataset.tab;
        
        // Update active tab button
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        // Show active tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabId}-tab`).classList.add('active');
        
        // Load data for the active tab
        if (tabId === 'organizations') {
            loadOrganizations(1);
        } else if (tabId === 'users') {
            loadUsers(1);
        } else if (tabId === 'activities') {
            loadActivities(1);
        }
    });
});

// Modal functions
function showAddOrganizationModal() {
    document.getElementById('addOrgModal').classList.add('active');
    document.getElementById('org-alert').style.display = 'none';
    document.getElementById('addOrgForm').reset();
}

function showAddOrgAdminModal() {
    // Load organizations without admins
    fetch('{% url "super_admin_organizations_api" %}?status=active')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const orgSelect = document.getElementById('org-select');
                orgSelect.innerHTML = '<option value="">Select Organization</option>';
                data.organizations.forEach(org => {
                    if (!org.has_admin) {
                        const option = document.createElement('option');
                        option.value = org.id;
                        option.textContent = org.name;
                        orgSelect.appendChild(option);
                    }
                });
                
                if (orgSelect.options.length <= 1) {
                    showAlert('info', 'All organizations already have administrators.');
                    return;
                }
                
                document.getElementById('addOrgAdminModal').classList.add('active');
                document.getElementById('org-admin-alert').style.display = 'none';
                document.getElementById('addOrgAdminForm').reset();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Failed to load organizations');
        });
}

function showEditOrganizationModal(orgId) {
    fetch(`/super-admin/organizations/${orgId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const org = data.organization;
                document.getElementById('edit-org-id').value = org.id;
                document.getElementById('edit-org-name').value = org.name;
                document.getElementById('edit-org-email').value = org.email;
                document.getElementById('edit-org-phone').value = org.phone;
                document.getElementById('edit-org-address').value = org.address;
                document.getElementById('edit-org-status').value = org.is_active.toString();
                document.getElementById('edit-org-alert').style.display = 'none';
                document.getElementById('editOrgModal').classList.add('active');
            } else {
                showAlert('error', data.error || 'Failed to load organization');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Failed to load organization');
        });
}

function showAddUserModal() {
    // Load organizations for dropdown
    fetch('{% url "super_admin_organizations_api" %}?status=active')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const orgSelect = document.querySelector('#addUserForm select[name="organization"]');
                orgSelect.innerHTML = '<option value="">Select Organization</option>';
                data.organizations.forEach(org => {
                    const option = document.createElement('option');
                    option.value = org.id;
                    option.textContent = org.name;
                    orgSelect.appendChild(option);
                });
            }
        });
    
    document.getElementById('addUserModal').classList.add('active');
    document.getElementById('user-alert').style.display = 'none';
    document.getElementById('addUserForm').reset();
    
    // Show/hide organization field based on role
    const roleSelect = document.querySelector('#addUserForm select[name="role"]');
    const orgGroup = document.getElementById('org-select-group');
    
    roleSelect.addEventListener('change', function() {
        if (this.value === 'organization_admin') {
            orgGroup.style.display = 'block';
            orgGroup.querySelector('select').required = true;
        } else {
            orgGroup.style.display = 'none';
            orgGroup.querySelector('select').required = false;
        }
    });
}

function showEditUserModal(userId) {
    fetch(`/super-admin/users/${userId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const user = data.user;
                
                // Load organizations for dropdown
                fetch('{% url "super_admin_organizations_api" %}?status=active')
                    .then(response => response.json())
                    .then(orgData => {
                        if (orgData.success) {
                            const orgSelect = document.getElementById('edit-user-organization');
                            orgSelect.innerHTML = '<option value="">Select Organization</option>';
                            orgData.organizations.forEach(org => {
                                const option = document.createElement('option');
                                option.value = org.id;
                                option.textContent = org.name;
                                if (user.organization && org.id === user.organization.id) {
                                    option.selected = true;
                                }
                                orgSelect.appendChild(option);
                            });
                        }
                    });
                
                document.getElementById('edit-user-id').value = user.id;
                document.getElementById('edit-user-username').value = user.username;
                document.getElementById('edit-user-email').value = user.email;
                document.getElementById('edit-user-first-name').value = user.first_name || '';
                document.getElementById('edit-user-last-name').value = user.last_name || '';
                document.getElementById('edit-user-role').value = user.role;
                document.getElementById('edit-user-phone').value = user.phone || '';
                document.getElementById('edit-user-status').value = user.is_active.toString();
                document.getElementById('edit-user-alert').style.display = 'none';
                document.getElementById('editUserModal').classList.add('active');
                
                // Show/hide organization field based on role
                const orgGroup = document.getElementById('edit-org-select-group');
                if (user.role === 'organization_admin') {
                    orgGroup.style.display = 'block';
                    orgGroup.querySelector('select').required = true;
                } else {
                    orgGroup.style.display = 'none';
                    orgGroup.querySelector('select').required = false;
                }
                
                // Add role change listener
                const roleSelect = document.getElementById('edit-user-role');
                roleSelect.addEventListener('change', function() {
                    if (this.value === 'organization_admin') {
                        orgGroup.style.display = 'block';
                        orgGroup.querySelector('select').required = true;
                    } else {
                        orgGroup.style.display = 'none';
                        orgGroup.querySelector('select').required = false;
                    }
                });
            } else {
                showAlert('error', data.error || 'Failed to load user');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('error', 'Failed to load user');
        });
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

// Close modals on outside click
document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.classList.remove('active');
        }
    });
});

// Quick create functions
function quickCreateOrganization() {
    const form = document.getElementById('quickOrgForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    fetch('{% url "super_admin_create_org" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            form.reset();
            loadOrganizations(1);
        } else {
            showAlert('error', data.error || 'Failed to create organization');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Failed to create organization');
    });
}

function quickCreateSuperAdmin() {
    const form = document.getElementById('quickSuperAdminForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    fetch('{% url "super_admin_create_super_admin" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPasswordModal(data.user.temp_password);
            form.reset();
            loadUsers(1);
        } else {
            showAlert('error', data.error || 'Failed to create super admin');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Failed to create super admin');
    });
}

// Form submissions
document.getElementById('addOrgForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    fetch('{% url "super_admin_create_org" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            closeModal('addOrgModal');
            loadOrganizations(1);
        } else {
            showAlertInModal('org-alert', 'error', data.error || 'Failed to create organization');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlertInModal('org-alert', 'error', 'Failed to create organization');
    });
});

document.getElementById('addOrgAdminForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    fetch('{% url "super_admin_create_org_admin" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPasswordModal(data.user.temp_password);
            closeModal('addOrgAdminModal');
            loadOrganizations(1);
        } else {
            showAlertInModal('org-admin-alert', 'error', data.error || 'Failed to create organization admin');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlertInModal('org-admin-alert', 'error', 'Failed to create organization admin');
    });
});

document.getElementById('addUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData.entries());
    
    let url = '{% url "super_admin_create_super_admin" %}';
    if (data.role === 'organization_admin') {
        url = '{% url "super_admin_create_org_admin" %}';
        data.org_id = data.organization;
    }
    
    fetch(url, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPasswordModal(data.user.temp_password);
            closeModal('addUserModal');
            loadUsers(1);
        } else {
            showAlertInModal('user-alert', 'error', data.error || 'Failed to create user');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlertInModal('user-alert', 'error', 'Failed to create user');
    });
});

// Load organizations via AJAX
function loadOrganizations(page = 1) {
    const search = document.getElementById('orgSearch').value;
    const status = document.getElementById('orgStatusFilter').value;
    
    let url = `{% url "super_admin_organizations_api" %}?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (status) url += `&status=${status}`;
    
    document.getElementById('organizations-loading').style.display = 'flex';
    document.getElementById('organizations-table').style.display = 'none';
    document.getElementById('organizations-empty').style.display = 'none';
    document.getElementById('organizations-pagination').style.display = 'none';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            document.getElementById('organizations-loading').style.display = 'none';
            
            if (data.success && data.organizations.length > 0) {
                const tbody = document.getElementById('organizations-table-body');
                tbody.innerHTML = '';
                
                data.organizations.forEach(org => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${org.id}</td>
                        <td>
                            <strong>${org.name}</strong>
                            <br><small class="text-muted">${org.slug}</small>
                        </td>
                        <td>${org.email}</td>
                        <td>${org.phone || '-'}</td>
                        <td>
                            <span class="status-badge ${org.is_active ? 'active' : 'inactive'}">
                                ${org.status}
                            </span>
                        </td>
                        <td>${new Date(org.created_at).toLocaleDateString()}</td>
                        <td>${org.user_count}</td>
                        <td>${org.admin_name}</td>
                        <td class="actions">
                            <button class="btn-icon btn-edit" title="Edit" onclick="showEditOrganizationModal(${org.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${!org.has_admin ? `
                            <button class="btn-icon btn-admin" title="Add Admin" onclick="showAddAdminToOrg(${org.id}, '${org.name}')">
                                <i class="fas fa-user-tie"></i>
                            </button>
                            ` : ''}
                            <button class="btn-icon btn-delete" title="Delete" onclick="showConfirmDelete('organization', ${org.id}, '${org.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('organizations-table').style.display = 'table';
                document.getElementById('organizations-pagination').style.display = 'flex';
                
                currentOrgPage = data.current_page;
                totalOrgPages = data.total_pages;
                
                updatePagination('org', currentOrgPage, totalOrgPages, data.total_count);
            } else {
                document.getElementById('organizations-empty').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('organizations-loading').style.display = 'none';
            document.getElementById('organizations-empty').style.display = 'block';
            document.getElementById('organizations-empty').innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error loading organizations</h3>
                <p>Please try again</p>
            `;
        });
}

// Load users via AJAX
function loadUsers(page = 1) {
    const search = document.getElementById('userSearch').value;
    const role = document.getElementById('userRoleFilter').value;
    const status = document.getElementById('userStatusFilter').value;
    
    let url = `/super-admin/users/api/?page=${page}`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (role) url += `&role=${role}`;
    if (status) url += `&status=${status}`;
    
    document.getElementById('users-loading').style.display = 'flex';
    document.getElementById('users-table').style.display = 'none';
    document.getElementById('users-empty').style.display = 'none';
    document.getElementById('users-pagination').style.display = 'none';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            document.getElementById('users-loading').style.display = 'none';
            
            if (data.success && data.users.length > 0) {
                const tbody = document.getElementById('users-table-body');
                tbody.innerHTML = '';
                
                data.users.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.id}</td>
                        <td>
                            <strong>${user.username}</strong>
                            ${user.first_name || user.last_name ? `<br><small>${user.first_name} ${user.last_name}</small>` : ''}
                        </td>
                        <td>
                            <span class="status-badge ${user.role === 'super_admin' ? 'super-admin' : 'org-admin'}">
                                ${user.role_display}
                            </span>
                        </td>
                        <td>${user.organization || '-'}</td>
                        <td>${user.email}</td>
                        <td>${user.last_active || 'Never'}</td>
                        <td>
                            <span class="status-badge ${user.is_active ? 'active' : 'inactive'}">
                                ${user.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td class="actions">
                            <button class="btn-icon btn-edit" title="Edit" onclick="showEditUserModal(${user.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-icon btn-reset" title="Reset Password" onclick="showConfirmResetPassword(${user.id}, '${user.username}')">
                                <i class="fas fa-key"></i>
                            </button>
                            ${user.id !== {{ request.user.id }} ? `
                            <button class="btn-icon btn-delete" title="Delete" onclick="showConfirmDelete('user', ${user.id}, '${user.username}')">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                document.getElementById('users-table').style.display = 'table';
                document.getElementById('users-pagination').style.display = 'flex';
                
                currentUserPage = data.current_page;
                totalUserPages = data.total_pages;
                
                updatePagination('user', currentUserPage, totalUserPages, data.total_count);
            } else {
                document.getElementById('users-empty').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('users-loading').style.display = 'none';
            document.getElementById('users-empty').style.display = 'block';
            document.getElementById('users-empty').innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <h3>Error loading users</h3>
                <p>Please try again</p>
            `;
        });
}

// Load activities via AJAX
function loadActivities(page = 1) {
    const search = document.getElementById('activitySearch').value;
    const action = document.getElementById('actionFilter').value;
    const module = document.getElementById('moduleFilter').value;
    const dateFrom = document.getElementById('dateFrom').value;
    const dateTo = document.getElementById('dateTo').value;
    
    let url = `/super-admin/activities/api/?page=${page}&per_page=20`;
    if (search) url += `&search=${encodeURIComponent(search)}`;
    if (action) url += `&action=${action}`;
    if (module) url += `&module=${module}`;
    if (dateFrom) url += `&date_from=${dateFrom}`;
    if (dateTo) url += `&date_to=${dateTo}`;
    
    const activitiesList = document.getElementById('activities-list');
    activitiesList.innerHTML = '<div class="loading"><i class="fas fa-spinner"></i> Loading activities...</div>';
    document.getElementById('activities-pagination').style.display = 'none';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.activities.length > 0) {
                activitiesList.innerHTML = '';
                
                data.activities.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    
                    let iconClass = 'fas fa-eye text-secondary';
                    let iconColor = 'text-secondary';
                    
                    switch(activity.action) {
                        case 'login':
                            iconClass = 'fas fa-sign-in-alt';
                            iconColor = 'text-success';
                            break;
                        case 'logout':
                            iconClass = 'fas fa-sign-out-alt';
                            iconColor = 'text-warning';
                            break;
                        case 'create':
                            iconClass = 'fas fa-plus-circle';
                            iconColor = 'text-primary';
                            break;
                        case 'update':
                            iconClass = 'fas fa-edit';
                            iconColor = 'text-info';
                            break;
                        case 'delete':
                            iconClass = 'fas fa-trash-alt';
                            iconColor = 'text-danger';
                            break;
                        case 'reset_password':
                            iconClass = 'fas fa-key';
                            iconColor = 'text-purple';
                            break;
                    }
                    
                    activityItem.innerHTML = `
                        <div class="activity-icon">
                            <i class="${iconClass} ${iconColor}"></i>
                        </div>
                        <div class="activity-content">
                            <div class="activity-header">
                                <strong>${activity.user.username}</strong>
                                <span class="badge badge-${activity.action}">${activity.action_display}</span>
                                <span class="badge badge-module">${activity.module}</span>
                                <span class="activity-time">${activity.time_ago}</span>
                            </div>
                            <p class="activity-description">${activity.description}</p>
                            <div class="activity-meta">
                                ${activity.organization ? `<span><i class="fas fa-building"></i> ${activity.organization}</span>` : ''}
                                ${activity.ip_address ? `<span><i class="fas fa-globe"></i> ${activity.ip_address}</span>` : ''}
                                ${activity.user_agent ? `<span><i class="fas fa-desktop"></i> ${activity.user_agent.substring(0, 50)}${activity.user_agent.length > 50 ? '...' : ''}</span>` : ''}
                            </div>
                        </div>
                    `;
                    activitiesList.appendChild(activityItem);
                });
                
                document.getElementById('activities-pagination').style.display = 'flex';
                
                currentActivityPage = data.current_page;
                totalActivityPages = data.total_pages;
                
                updatePagination('activity', currentActivityPage, totalActivityPages, data.total_count);
            } else {
                activitiesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-history"></i>
                        <h3>No activity logs found</h3>
                        <p>Activities will appear here as users interact with the system</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            activitiesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error loading activities</h3>
                    <p>Please try again</p>
                </div>
            `;
        });
}

// Update pagination controls
function updatePagination(type, currentPage, totalPages, totalCount) {
    const firstBtn = document.getElementById(`${type}-first-page`);
    const prevBtn = document.getElementById(`${type}-prev-page`);
    const nextBtn = document.getElementById(`${type}-next-page`);
    const lastBtn = document.getElementById(`${type}-last-page`);
    const pageInfo = document.getElementById(`${type}-page-info`);
    
    // Update page info
    pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${totalCount} total)`;
    
    // Update button states
    firstBtn.disabled = currentPage === 1;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
    lastBtn.disabled = currentPage === totalPages;
}

// Confirmation functions
function showConfirmDelete(type, id, name) {
    pendingAction = `delete_${type}`;
    pendingActionData = { id: id, name: name };
    
    document.getElementById('confirm-message').innerHTML = `
        Are you sure you want to delete this ${type}?<br>
        <strong>${name}</strong><br><br>
        <small class="text-danger">This action cannot be undone!</small>
    `;
    
    document.getElementById('confirm-action-btn').className = 'btn btn-danger';
    document.getElementById('confirm-action-btn').innerHTML = `<i class="fas fa-trash"></i> Delete ${type.charAt(0).toUpperCase() + type.slice(1)}`;
    document.getElementById('confirmModal').classList.add('active');
}

function showConfirmResetPassword(userId, username) {
    pendingAction = 'reset_password';
    pendingActionData = { id: userId, username: username };
    
    document.getElementById('confirm-message').innerHTML = `
        Are you sure you want to reset password for user?<br>
        <strong>${username}</strong><br><br>
        <small class="text-warning">A new temporary password will be generated.</small>
    `;
    
    document.getElementById('confirm-action-btn').className = 'btn btn-warning';
    document.getElementById('confirm-action-btn').innerHTML = `<i class="fas fa-key"></i> Reset Password`;
    document.getElementById('confirmModal').classList.add('active');
}

// Confirm action handler
document.getElementById('confirm-action-btn').addEventListener('click', function() {
    if (pendingAction === 'delete_organization') {
        deleteOrganization(pendingActionData.id);
    } else if (pendingAction === 'delete_user') {
        deleteUser(pendingActionData.id);
    } else if (pendingAction === 'reset_password') {
        resetUserPassword(pendingActionData.id);
    }
    
    closeModal('confirmModal');
    pendingAction = null;
    pendingActionData = null;
});

// Organization CRUD functions
function showAddAdminToOrg(orgId, orgName) {
    // Set organization in the form
    const orgSelect = document.getElementById('org-select');
    for (let option of orgSelect.options) {
        if (option.value == orgId) {
            option.selected = true;
            break;
        }
    }
    
    // Show the modal
    document.getElementById('addOrgAdminModal').classList.add('active');
    document.getElementById('org-admin-alert').style.display = 'none';
    document.getElementById('addOrgAdminForm').reset();
}

function deleteOrganization(orgId) {
    fetch('{% url "super_admin_delete_organization" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ org_id: orgId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            loadOrganizations(currentOrgPage);
        } else {
            showAlert('error', data.error || 'Failed to delete organization');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Failed to delete organization');
    });
}

// User CRUD functions
function resetUserPassword(userId) {
    fetch('{% url "super_admin_reset_user_password" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ user_id: userId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPasswordModal(data.temp_password);
            loadUsers(currentUserPage);
        } else {
            showAlert('error', data.error || 'Failed to reset password');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Failed to reset password');
    });
}

function deleteUser(userId) {
    fetch('{% url "super_admin_delete_user" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ user_id: userId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            loadUsers(currentUserPage);
        } else {
            showAlert('error', data.error || 'Failed to delete user');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Failed to delete user');
    });
}

// Password modal functions
function showPasswordModal(password) {
    document.getElementById('temp-password-display').textContent = password;
    document.getElementById('passwordModal').classList.add('active');
}

function copyPassword() {
    const password = document.getElementById('temp-password-display').textContent;
    navigator.clipboard.writeText(password).then(() => {
        showAlert('success', 'Password copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy password: ', err);
        showAlert('error', 'Failed to copy password');
    });
}

// System settings functions
function saveSecuritySettings() {
    const passwordPolicy = document.getElementById('passwordPolicy').value;
    const sessionTimeout = document.getElementById('sessionTimeout').value;
    
    // In a real application, you would save these settings to the database
    showAlert('success', 'Security settings saved successfully!');
}

function saveNotificationSettings() {
    // In a real application, you would save these settings to the database
    showAlert('success', 'Notification settings saved successfully!');
}

function backupSystem() {
    showAlert('info', 'System backup started... This may take a few minutes.');
    
    // Simulate backup process
    setTimeout(() => {
        showAlert('success', 'System backup completed successfully!');
    }, 2000);
}

// Helper functions
function showAlert(type, message) {
    // Remove existing alerts
    document.querySelectorAll('.global-alert').forEach(alert => alert.remove());
    
    const alertDiv = document.createElement('div');
    alertDiv.className = `global-alert alert alert-${type}`;
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        min-width: 300px;
        max-width: 500px;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
    `;
    
    let icon = 'fas fa-info-circle';
    if (type === 'success') icon = 'fas fa-check-circle';
    if (type === 'error') icon = 'fas fa-exclamation-circle';
    if (type === 'warning') icon = 'fas fa-exclamation-triangle';
    
    alertDiv.innerHTML = `
        <div style="display: flex; align-items: center; gap: 10px;">
            <i class="${icon}" style="font-size: 18px;"></i>
            <div style="flex: 1;">${message}</div>
            <button onclick="this.parentElement.parentElement.remove()" style="background: none; border: none; cursor: pointer; color: inherit;">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => alertDiv.remove(), 300);
        }
    }, 5000);
}

function showAlertInModal(modalAlertId, type, message) {
    const alertDiv = document.getElementById(modalAlertId);
    alertDiv.className = `alert-message alert-${type}`;
    alertDiv.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'exclamation'}-circle"></i> ${message}`;
    alertDiv.style.display = 'block';
}

// Search functionality with debounce
let orgSearchTimeout;
document.getElementById('orgSearch').addEventListener('input', function() {
    clearTimeout(orgSearchTimeout);
    orgSearchTimeout = setTimeout(() => {
        loadOrganizations(1);
    }, 500);
});

let userSearchTimeout;
document.getElementById('userSearch').addEventListener('input', function() {
    clearTimeout(userSearchTimeout);
    userSearchTimeout = setTimeout(() => {
        loadUsers(1);
    }, 500);
});

let activitySearchTimeout;
document.getElementById('activitySearch').addEventListener('input', function() {
    clearTimeout(activitySearchTimeout);
    activitySearchTimeout = setTimeout(() => {
        loadActivities(1);
    }, 500);
});

// Filter change listeners
document.getElementById('orgStatusFilter').addEventListener('change', () => loadOrganizations(1));
document.getElementById('userRoleFilter').addEventListener('change', () => loadUsers(1));
document.getElementById('userStatusFilter').addEventListener('change', () => loadUsers(1));
document.getElementById('actionFilter').addEventListener('change', () => loadActivities(1));
document.getElementById('moduleFilter').addEventListener('change', () => loadActivities(1));
document.getElementById('dateFrom').addEventListener('change', () => loadActivities(1));
document.getElementById('dateTo').addEventListener('change', () => loadActivities(1));

// Initialize data on page load
document.addEventListener('DOMContentLoaded', () => {
    // Load organizations tab by default
    loadOrganizations(1);
    
    // Add today's date to date filters
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('dateTo').value = today;
    
    // Set date from to 7 days ago
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    document.getElementById('dateFrom').value = sevenDaysAgo.toISOString().split('T')[0];
    
    // Add CSS for alerts animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        @keyframes slideOut {
            from {
                opacity: 1;
                transform: translateX(0);
            }
            to {
                opacity: 0;
                transform: translateX(100%);
            }
        }
    `;
    document.head.appendChild(style);
});
</script>
{% endblock %}